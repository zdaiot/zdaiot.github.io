<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 3.9.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"www.zdaiot.com",root:"/",scheme:"Gemini",version:"7.8.0",exturl:!1,sidebar:{position:"left",display:"post",offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:null},back2top:{enable:!0,sidebar:!0,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.xml"}</script><meta name="description" content="一直对node.js与npm感觉很陌生，最近需要用到了，所以这里学习一下。以下文章主要参考了ConardLi的剖析 NPM 的包管理机制。因为本人纯小白，所以会添加一些其它的知识。 现如今，前端开发的同学已经离不开 npm 这个包管理工具，其优秀的包版本管理机制承载了整个繁荣发展的NodeJS社区，理解其内部机制非常有利于加深我们对模块开发的理解、各项前端工程化的配置以加快我们排查问题（相信不少同"><meta name="keywords" content="npm,yarn,node.js"><meta property="og:type" content="article"><meta property="og:title" content="剖析 NPM 的包管理机制"><meta property="og:url" content="https://www.zdaiot.com/Linux/博客搭建/剖析 NPM 的包管理机制/index.html"><meta property="og:site_name" content="zdaiot"><meta property="og:description" content="一直对node.js与npm感觉很陌生，最近需要用到了，所以这里学习一下。以下文章主要参考了ConardLi的剖析 NPM 的包管理机制。因为本人纯小白，所以会添加一些其它的知识。 现如今，前端开发的同学已经离不开 npm 这个包管理工具，其优秀的包版本管理机制承载了整个繁荣发展的NodeJS社区，理解其内部机制非常有利于加深我们对模块开发的理解、各项前端工程化的配置以加快我们排查问题（相信不少同"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://www.zdaiot.com/Linux/博客搭建/剖析%20NPM%20的包管理机制/16f0eef28758e8c0tplv-t2oaga2asx-image.png"><meta property="og:image" content="https://www.zdaiot.com/Linux/博客搭建/剖析%20NPM%20的包管理机制/16f0eef28368aba9tplv-t2oaga2asx-image.png"><meta property="og:image" content="https://www.zdaiot.com/Linux/博客搭建/剖析%20NPM%20的包管理机制/16f0eef28544db20tplv-t2oaga2asx-image.png"><meta property="og:image" content="https://www.zdaiot.com/Linux/博客搭建/剖析%20NPM%20的包管理机制/16f0eef2871aa774tplv-t2oaga2asx-image.png"><meta property="og:image" content="https://www.zdaiot.com/Linux/博客搭建/剖析%20NPM%20的包管理机制/16f0eef285e805c7tplv-t2oaga2asx-image.png"><meta property="og:image" content="https://www.zdaiot.com/Linux/博客搭建/剖析%20NPM%20的包管理机制/16f0eef2b2a3e5c4tplv-t2oaga2asx-image.png"><meta property="og:image" content="https://www.zdaiot.com/Linux/博客搭建/剖析%20NPM%20的包管理机制/16f0eef2b7fb2674tplv-t2oaga2asx-image.png"><meta property="og:image" content="https://www.zdaiot.com/Linux/博客搭建/剖析%20NPM%20的包管理机制/16f0eef2b2f744d8tplv-t2oaga2asx-image.png"><meta property="og:image" content="https://www.zdaiot.com/Linux/博客搭建/剖析%20NPM%20的包管理机制/16f0eef2bd8639b2tplv-t2oaga2asx-image.png"><meta property="og:image" content="https://www.zdaiot.com/Linux/博客搭建/剖析%20NPM%20的包管理机制/16f0eef2d5915089tplv-t2oaga2asx-image.png"><meta property="og:image" content="https://www.zdaiot.com/Linux/博客搭建/剖析%20NPM%20的包管理机制/16f0eef2c221c0cdtplv-t2oaga2asx-image.png"><meta property="og:image" content="https://www.zdaiot.com/Linux/博客搭建/剖析%20NPM%20的包管理机制/16f0eef2f07ab9ectplv-t2oaga2asx-image.png"><meta property="og:image" content="https://www.zdaiot.com/Linux/博客搭建/剖析%20NPM%20的包管理机制/16f0eef2f8072f86tplv-t2oaga2asx-image.png"><meta property="og:image" content="https://www.zdaiot.com/Linux/博客搭建/剖析%20NPM%20的包管理机制/16f0eef301559a8etplv-t2oaga2asx-image.png"><meta property="og:image" content="https://www.zdaiot.com/Linux/博客搭建/剖析%20NPM%20的包管理机制/16f0eef3016562c8tplv-t2oaga2asx-image.png"><meta property="og:image" content="https://www.zdaiot.com/Linux/博客搭建/剖析%20NPM%20的包管理机制/16f0eef302c760fetplv-t2oaga2asx-image.png"><meta property="og:image" content="https://www.zdaiot.com/Linux/博客搭建/剖析%20NPM%20的包管理机制/16f0eef3224e9335tplv-t2oaga2asx-image.gif"><meta property="og:image" content="https://www.zdaiot.com/Linux/博客搭建/剖析%20NPM%20的包管理机制/16f0eef31ae6c1ebtplv-t2oaga2asx-image.png"><meta property="og:image" content="https://www.zdaiot.com/Linux/博客搭建/剖析%20NPM%20的包管理机制/16f0eef327ccaba5tplv-t2oaga2asx-image.png"><meta property="og:image" content="https://www.zdaiot.com/Linux/博客搭建/剖析%20NPM%20的包管理机制/16f0eef33997d7f2tplv-t2oaga2asx-image.png"><meta property="og:image" content="https://www.zdaiot.com/Linux/博客搭建/剖析%20NPM%20的包管理机制/16f0eef33d822969tplv-t2oaga2asx-image.png"><meta property="og:image" content="https://www.zdaiot.com/Linux/博客搭建/剖析%20NPM%20的包管理机制/16f0eef3518941f2tplv-t2oaga2asx-image.png"><meta property="og:image" content="https://www.zdaiot.com/Linux/博客搭建/剖析%20NPM%20的包管理机制/16f0eef3519475d1tplv-t2oaga2asx-image.png"><meta property="og:image" content="https://www.zdaiot.com/Linux/博客搭建/剖析%20NPM%20的包管理机制/16f0eef355ae3b37tplv-t2oaga2asx-image.png"><meta property="og:image" content="https://www.zdaiot.com/Linux/博客搭建/剖析%20NPM%20的包管理机制/16f0eef35ae17872tplv-t2oaga2asx-image.png"><meta property="og:image" content="https://www.zdaiot.com/Linux/博客搭建/剖析%20NPM%20的包管理机制/16f0eef377260d67tplv-t2oaga2asx-image.png"><meta property="og:image" content="https://www.zdaiot.com/Linux/博客搭建/剖析%20NPM%20的包管理机制/16f0eef3824eba10tplv-t2oaga2asx-image.png"><meta property="og:image" content="https://www.zdaiot.com/Linux/博客搭建/剖析%20NPM%20的包管理机制/16f0eef38a55f11etplv-t2oaga2asx-image.png"><meta property="og:image" content="https://www.zdaiot.com/Linux/博客搭建/剖析%20NPM%20的包管理机制/16f0eef3a81eb51ftplv-t2oaga2asx-image.png"><meta property="og:image" content="https://www.zdaiot.com/Linux/博客搭建/剖析%20NPM%20的包管理机制/16f0eef35ae17872tplv-t2oaga2asx-image.png"><meta property="og:image" content="https://www.zdaiot.com/Linux/博客搭建/剖析%20NPM%20的包管理机制/16f0eef39713273atplv-t2oaga2asx-image.gif"><meta property="og:image" content="https://www.zdaiot.com/Linux/博客搭建/剖析%20NPM%20的包管理机制/16f0eef3b5e532e0tplv-t2oaga2asx-image.gif"><meta property="og:image" content="https://www.zdaiot.com/Linux/博客搭建/剖析%20NPM%20的包管理机制/16f0eef3b8fb68f5tplv-t2oaga2asx-image.png"><meta property="og:image" content="https://www.zdaiot.com/Linux/博客搭建/剖析%20NPM%20的包管理机制/16f0eef3bc635b03tplv-t2oaga2asx-image.png"><meta property="og:image" content="https://www.zdaiot.com/Linux/博客搭建/剖析%20NPM%20的包管理机制/16f0eef3c2a2dac0tplv-t2oaga2asx-image.png"><meta property="og:image" content="https://www.zdaiot.com/Linux/博客搭建/剖析%20NPM%20的包管理机制/16f0eef327ccaba5tplv-t2oaga2asx-image.png"><meta property="og:image" content="https://www.zdaiot.com/Linux/博客搭建/剖析%20NPM%20的包管理机制/16f0eef3dde095abtplv-t2oaga2asx-image.png"><meta property="og:image" content="https://www.zdaiot.com/Linux/博客搭建/剖析%20NPM%20的包管理机制/16f0eef3e0ee2fbdtplv-t2oaga2asx-image.png"><meta property="og:image" content="https://www.zdaiot.com/Linux/博客搭建/剖析%20NPM%20的包管理机制/16f0eef3eb66af39tplv-t2oaga2asx-image.png"><meta property="og:image" content="https://www.zdaiot.com/Linux/博客搭建/剖析%20NPM%20的包管理机制/watermark,type_ZmFuZ3poZW5naGVpdGk.png"><meta property="og:image" content="https://www.zdaiot.com/Linux/博客搭建/剖析%20NPM%20的包管理机制/687474703a2f2f7366312d687363646e2d746f.png"><meta property="og:updated_time" content="2023-04-12T09:14:11.000Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="剖析 NPM 的包管理机制"><meta name="twitter:description" content="一直对node.js与npm感觉很陌生，最近需要用到了，所以这里学习一下。以下文章主要参考了ConardLi的剖析 NPM 的包管理机制。因为本人纯小白，所以会添加一些其它的知识。 现如今，前端开发的同学已经离不开 npm 这个包管理工具，其优秀的包版本管理机制承载了整个繁荣发展的NodeJS社区，理解其内部机制非常有利于加深我们对模块开发的理解、各项前端工程化的配置以加快我们排查问题（相信不少同"><meta name="twitter:image" content="https://www.zdaiot.com/Linux/博客搭建/剖析%20NPM%20的包管理机制/16f0eef28758e8c0tplv-t2oaga2asx-image.png"><link rel="canonical" href="https://www.zdaiot.com/Linux/博客搭建/剖析 NPM 的包管理机制/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-CN"}</script><title>剖析 NPM 的包管理机制 | zdaiot</title><script data-pjax>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?0b0b58037319da4959d5a3c014160ccd";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">zdaiot</h1><span class="logo-line-after"><i></i></span></a><p class="site-subtitle" itemprop="description">404NotFound</p></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul id="menu" class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i> 首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i> 关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i> 归档</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"><div id="no-result"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></div></header><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content post posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.zdaiot.com/Linux/博客搭建/剖析 NPM 的包管理机制/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/uploads/avatar.png"><meta itemprop="name" content="zdaiot"><meta itemprop="description" content="404NotFound"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="zdaiot"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> 剖析 NPM 的包管理机制<a href="https://github.com/zdaiot/zdaiot.github.io/tree/hexo/source/_posts/Linux/博客搭建/剖析 NPM 的包管理机制.md" class="post-edit-link" title="编辑" rel="noopener" target="_blank"><i class="fa fa-pencil-alt"></i></a></h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2023-04-12 17:14:11" itemprop="dateCreated datePublished" datetime="2023-04-12T17:14:11+08:00">2023-04-12</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux/博客搭建/" itemprop="url" rel="index"><span itemprop="name">博客搭建</span></a></span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>45k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span>41 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><p>一直对node.js与npm感觉很陌生，最近需要用到了，所以这里学习一下。以下文章主要参考了ConardLi的<a href="https://blog.conardli.top/2019/12/17/engineering/npm/#3-6-%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B" target="_blank" rel="noopener">剖析 NPM 的包管理机制</a>。因为本人纯小白，所以会添加一些其它的知识。</p><p>现如今，前端开发的同学已经离不开 <code>npm</code> 这个包管理工具，其优秀的<strong>包版本管理机制</strong>承载了整个繁荣发展的<code>NodeJS</code>社区，理解其内部机制非常有利于加深我们对模块开发的理解、各项前端工程化的配置以加快我们排查问题（相信不少同学收到过各种依赖问题的困扰）的速度。</p><p>本文从三个角度：<code>package.json</code>、版本管理、依赖安装结合具体实例对 <code>npm</code> 的包管理机制进行了详细分析。</p><h2 id="剖析-package-json"><a href="#剖析-package-json" class="headerlink" title="剖析 package.json"></a>剖析 package.json</h2><p><img src="/Linux/博客搭建/剖析 NPM 的包管理机制/16f0eef28758e8c0tplv-t2oaga2asx-image.png" alt></p><p>在 <code>Node.js</code> 中，模块是一个库或框架，也是一个 <code>Node.js</code> 项目。<code>Node.js</code> 项目遵循模块化的架构，当我们创建了一个 <code>Node.js</code> 项目，意味着创建了一个模块，这个模块必须有一个描述文件，即 <code>package.json</code>。它是我们最常见的配置文件，但是它里面的配置你真的有详细了解过吗？配置一个合理的 <code>package.json</code> 文件直接决定着我们项目的质量，所以首先带大家分析下 <code>package.json</code> 的各项详细配置。</p><h3 id="必备属性"><a href="#必备属性" class="headerlink" title="必备属性"></a>必备属性</h3><p><code>package.json</code> 中有非常多的属性，其中必须填写的只有两个：<code>name</code> 和 <code>version</code> ，这两个属性组成一个 <code>npm</code> 模块的唯一标识。</p><h4 id="npm包命名规则"><a href="#npm包命名规则" class="headerlink" title="npm包命名规则"></a>npm包命名规则</h4><p><code>name</code> 即模块名称，其命名时需要遵循官方的一些规范和建议：</p><ul><li><p>包名会成为模块<code>url</code>、命令行中的一个参数或者一个文件夹名称，任何非<code>url</code>安全的字符在包名中都不能使用，可以使用 <code>validate-npm-package-name</code> 包来检测包名是否合法。</p></li><li><p>语义化包名，可以帮助开发者更快的找到需要的包，并且避免意外获取错误的包。</p></li><li><p>若包名称中存在一些符号，将符号去除后不得与现有包名重复</p></li></ul><p>例如：由于<code>react-native</code>已经存在，<code>react.native</code>、<code>reactnative</code>都不可以再创建。</p><ul><li>如果你的包名与现有的包名太相近导致你不能发布这个包，那么推荐将这个包发布到你的作用域下。</li></ul><p>例如：用户名 <code>conard</code>，那么作用域为 <code>@conard</code>，发布的包可以是<code>@conard/react</code>。</p><h4 id="查看包是否被占用"><a href="#查看包是否被占用" class="headerlink" title="查看包是否被占用"></a>查看包是否被占用</h4><p><code>name</code> 是一个包的唯一标识，不得和其他包名重复，我们可以执行 <code>npm view packageName</code> 查看包是否被占用，并可以查看它的一些基本信息：</p><p><img src="/Linux/博客搭建/剖析 NPM 的包管理机制/16f0eef28368aba9tplv-t2oaga2asx-image.png" alt></p><p>若包名称从未被使用过，则会抛出 <code>404</code> 错误：</p><p><img src="/Linux/博客搭建/剖析 NPM 的包管理机制/16f0eef28544db20tplv-t2oaga2asx-image.png" alt></p><p>另外，你还可以去 <code>https://www.npmjs.com/</code> 查询更多更详细的包信息。</p><h3 id="描述信息"><a href="#描述信息" class="headerlink" title="描述信息"></a>描述信息</h3><h4 id="基本描述"><a href="#基本描述" class="headerlink" title="基本描述"></a>基本描述</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"description"</span>: <span class="string">"An enterprise-class UI design language and React components implementation"</span>,</span><br><span class="line">  <span class="attr">"keywords"</span>: [</span><br><span class="line">    <span class="string">"ant"</span>,</span><br><span class="line">    <span class="string">"component"</span>,</span><br><span class="line">    <span class="string">"components"</span>,</span><br><span class="line">    <span class="string">"design"</span>,</span><br><span class="line">    <span class="string">"framework"</span>,</span><br><span class="line">    <span class="string">"frontend"</span>,</span><br><span class="line">    <span class="string">"react"</span>,</span><br><span class="line">    <span class="string">"react-component"</span>,</span><br><span class="line">    <span class="string">"ui"</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>description</code>用于添加模块的的描述信息，方便别人了解你的模块。</p><p><code>keywords</code>用于给你的模块添加关键字。</p><p>当然，他们的还有一个非常重要的作用，就是利于模块检索。当你使用 <code>npm search</code> 检索模块时，会到<code>description</code> 和 <code>keywords</code> 中进行匹配。写好 <code>description</code> 和 <code>keywords</code> 有利于你的模块获得更多更精准的曝光：</p><p><img src="/Linux/博客搭建/剖析 NPM 的包管理机制/16f0eef2871aa774tplv-t2oaga2asx-image.png" alt></p><h4 id="开发人员"><a href="#开发人员" class="headerlink" title="开发人员"></a>开发人员</h4><p>描述开发人员的字段有两个：<code>author</code> 和 <code>contributors</code>， <code>author</code> 指包的主要作者，一个 <code>author</code> 对应一个人。 <code>contributors</code> 指贡献者信息，一个 <code>contributors</code> 对应多个贡献者，值为数组，对人的描述可以是一个字符串，也可以是下面的结构：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123; </span><br><span class="line">    <span class="attr">"name"</span> : <span class="string">"ConardLi"</span>, </span><br><span class="line">    <span class="attr">"email"</span> : <span class="string">"lisqPersion@163.com"</span>, </span><br><span class="line">    <span class="attr">"url"</span> : <span class="string">"https://github.com/ConardLi"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="地址"><a href="#地址" class="headerlink" title="地址"></a>地址</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"homepage"</span>: <span class="string">"http://ant.design/"</span>,</span><br><span class="line">  <span class="attr">"bugs"</span>: &#123;</span><br><span class="line">    <span class="attr">"url"</span>: <span class="string">"https://github.com/ant-design/ant-design/issues"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"repository"</span>: &#123;</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"git"</span>,</span><br><span class="line">    <span class="attr">"url"</span>: <span class="string">"https://github.com/ant-design/ant-design"</span></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>homepage</code> 用于指定该模块的主页。</p><p><code>repository</code> 用于指定模块的代码仓库。</p><p><img src="/Linux/博客搭建/剖析 NPM 的包管理机制/16f0eef285e805c7tplv-t2oaga2asx-image.png" alt></p><p><code>bugs</code> 指定一个地址或者一个邮箱，对你的模块存在疑问的人可以到这里提出问题。</p><h3 id="依赖配置"><a href="#依赖配置" class="headerlink" title="依赖配置"></a>依赖配置</h3><p>我们的项目可能依赖一个或多个外部依赖包，根据依赖包的不同用途，我们将他们配置在下面几个属性下：<code>dependencies、devDependencies、peerDependencies、bundledDependencies、optionalDependencies</code>。</p><h4 id="配置规则"><a href="#配置规则" class="headerlink" title="配置规则"></a>配置规则</h4><p>在介绍几种依赖配置之前，首先我们来看一下依赖的配置规则，你看到的依赖包配置可能是下面这样的：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">"dependencies": &#123;</span><br><span class="line">     "antd": "ant-design/ant-design#4.0.0-alpha.8",</span><br><span class="line">     "axios": "^1.2.0",</span><br><span class="line">     "test-js": "file:../test",</span><br><span class="line">     "test2-js": "http://cdn.com/test2-js.tar.gz",</span><br><span class="line">     "core-js": "^1.1.5",</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>依赖配置遵循下面几种配置规则：</p><ul><li><code>依赖包名称:VERSION</code><ul><li><code>VERSION</code>是一个遵循<code>SemVer</code>规范的版本号配置，<code>npm install</code> 时将到npm服务器下载符合指定版本范围的包。</li></ul></li><li><code>依赖包名称:DWONLOAD_URL</code><ul><li><code>DWONLOAD_URL</code> 是一个可下载的<code>tarball</code>压缩包地址，模块安装时会将这个<code>.tar</code>下载并安装到本地。</li></ul></li><li><code>依赖包名称:LOCAL_PATH</code><ul><li><code>LOCAL_PATH</code> 是一个本地的依赖包路径，例如 <code>file:../pacakges/pkgName</code>。适用于你在本地测试一个<code>npm</code>包，不应该将这种方法应用于线上。</li></ul></li><li><code>依赖包名称:GITHUB_URL</code><ul><li><code>GITHUB_URL</code> 即 <code>github</code> 的 <code>username/modulename</code> 的写法，例如：<code>ant-design/ant-design</code>，你还可以在后面指定 <code>tag</code> 和 <code>commit id</code>。</li></ul></li><li><code>依赖包名称:GIT_URL</code><ul><li><code>GIT_URL</code> 即我们平时clone代码库的 <code>git url</code>，其遵循以下形式：</li></ul></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;protocol&gt;:<span class="comment">//[&lt;user&gt;[:&lt;password&gt;]@]&lt;hostname&gt;[:&lt;port&gt;][:][/]&lt;path&gt;[#&lt;commit-ish&gt; | #semver:&lt;semver&gt;]</span></span><br></pre></td></tr></table></figure><p>其中 <code>protocal</code> 可以是以下几种形式：</p><ul><li><code>git://github.com/user/project.git#commit-ish</code></li><li><code>git+ssh://user@hostname:project.git#commit-ish</code></li><li><code>git+ssh://user@hostname/project.git#commit-ish</code></li><li><code>git+http://user@hostname/project/blah.git#commit-ish</code></li><li><code>git+https://user@hostname/project/blah.git#commit-ish</code></li></ul><h4 id="dependencies"><a href="#dependencies" class="headerlink" title="dependencies"></a>dependencies</h4><p><code>dependencies</code> 指定了项目运行所依赖的模块，开发环境和生产环境的依赖模块都可以配置到这里，例如</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">"dependencies": &#123;</span><br><span class="line">     "lodash": "^4.17.13",</span><br><span class="line">     "moment": "^2.24.0",</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="devDependencies"><a href="#devDependencies" class="headerlink" title="devDependencies"></a>devDependencies</h4><p>有一些包有可能你只是在开发环境中用到，例如你用于检测代码规范的 <code>eslint</code> ,用于进行测试的 <code>jest</code> ，用户使用你的包时即使不安装这些依赖也可以正常运行，反而安装他们会耗费更多的时间和资源，所以你可以把这些依赖添加到 <code>devDependencies</code> 中，这些依赖照样会在你本地进行 <code>npm install</code> 时被安装和管理，但是不会被安装到生产环境：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">"devDependencies": &#123;</span><br><span class="line">     "jest": "^24.3.1",</span><br><span class="line">     "eslint": "^6.1.0",</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="peerDependencies"><a href="#peerDependencies" class="headerlink" title="peerDependencies"></a>peerDependencies</h4><p><code>peerDependencies</code> 用于指定你正在开发的模块所依赖的版本以及用户安装的依赖包版本的兼容性。</p><p>上面的说法可能有点太抽象，我们直接拿 <code>ant-design</code> 来举个例子，<code>ant-design</code> 的 <code>package.json</code> 中有如下配置：<br></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">"peerDependencies": &#123;</span><br><span class="line">  "react": "&gt;=16.0.0",</span><br><span class="line">  "react-dom": "&gt;=16.0.0"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>当你正在开发一个系统，使用了 <code>ant-design</code> ，所以也肯定需要依赖 <code>React</code>。同时， <code>ant-design</code> 也是需要依赖 <code>React</code> 的，它要保持稳定运行所需要的 <code>React</code> 版本是<code>16.0.0</code>，而你开发时依赖的 <code>React</code> 版本是 <code>15.x</code>：</p><p>这时，<code>ant-design</code> 要使用 <code>React</code>，并将其引入：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> ReactDOM <span class="keyword">from</span> <span class="string">'react-dom'</span>;</span><br></pre></td></tr></table></figure><p>这时取到的是宿主环境也就是你的环境中的 <code>React</code> 版本，这就可能造成一些问题。在 <code>npm2</code> 的时候，指定上面的 <code>peerDependencies</code> 将意味着强制宿主环境安装 <code>react@&gt;=16.0.0和react-dom@&gt;=16.0.0</code> 的版本。</p><p><code>npm3</code> 以后不会再要求 <code>peerDependencies</code> 所指定的依赖包被强制安装，相反 <code>npm3</code> 会在安装结束后检查本次安装是否正确，如果不正确会给用户打印警告提示。</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">"dependencies": &#123;</span><br><span class="line">  "react": "15.6.0",</span><br><span class="line">  "antd": "^3.22.0"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>例如，我在项目中依赖了 <code>antd</code> 的最新版本，然后依赖了 <code>react</code> 的 <code>15.6.0</code>版本，在进行依赖安装时将给出以下警告：</p><p><img src="/Linux/博客搭建/剖析 NPM 的包管理机制/16f0eef2b2a3e5c4tplv-t2oaga2asx-image.png" alt></p><h4 id="optionalDependencies"><a href="#optionalDependencies" class="headerlink" title="optionalDependencies"></a>optionalDependencies</h4><p>某些场景下，依赖包可能不是强依赖的，这个依赖包的功能可有可无，当这个依赖包无法被获取到时，你希望 <code>npm install</code> 继续运行，而不会导致失败，你可以将这个依赖放到 <code>optionalDependencies</code> 中，注意 <code>optionalDependencies</code> 中的配置将会覆盖掉 <code>dependencies</code> 所以只需在一个地方进行配置。</p><p>当然，引用 <code>optionalDependencies</code> 中安装的依赖时，一定要做好异常处理，否则在模块获取不到时会导致报错。</p><h4 id="bundledDependencies"><a href="#bundledDependencies" class="headerlink" title="bundledDependencies"></a>bundledDependencies</h4><p>和以上几个不同，<code>bundledDependencies</code> 的值是一个数组，数组里可以指定一些模块，这些模块将在这个包发布时被一起打包。</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">"bundledDependencies": ["package1" , "package2"]</span><br></pre></td></tr></table></figure><h3 id="协议"><a href="#协议" class="headerlink" title="协议"></a>协议</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"license"</span>: <span class="string">"MIT"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>license</code> 字段用于指定软件的开源协议，开源协议里面详尽表述了其他人获得你代码后拥有的权利，可以对你的的代码进行何种操作，何种操作又是被禁止的。同一款协议有很多变种，协议太宽松会导致作者丧失对作品的很多权利，太严格又不便于使用者使用及作品的传播，所以开源作者要考虑自己对作品想保留哪些权利，放开哪些限制。</p><blockquote><p>软件协议可分为开源和商业两类，对于商业协议，或者叫法律声明、许可协议，每个软件会有自己的一套行文，由软件作者或专门律师撰写，对于大多数人来说不必自己花时间和精力去写繁长的许可协议，选择一份广为流传的开源协议就是个不错的选择。</p></blockquote><p>以下就是几种主流的开源协议：</p><p><img src="/Linux/博客搭建/剖析 NPM 的包管理机制/16f0eef2b7fb2674tplv-t2oaga2asx-image.png" alt></p><ul><li><code>MIT</code>：只要用户在项目副本中包含了版权声明和许可声明，他们就可以拿你的代码做任何想做的事情，你也无需承担任何责任。</li><li><code>Apache</code>：类似于 <code>MIT</code>，同时还包含了贡献者向用户提供专利授权相关的条款。</li><li><code>GPL</code>：修改项目代码的用户再次分发源码或二进制代码时，必须公布他的相关修改。</li></ul><p>如果你对开源协议有更详细的要求，可以到 <a href="https://choosealicense.com/" target="_blank" rel="noopener">https://choosealicense.com/</a> 获取更详细的开源协议说明。</p><p><img src="/Linux/博客搭建/剖析 NPM 的包管理机制/16f0eef2b2f744d8tplv-t2oaga2asx-image.png" alt></p><h3 id="目录、文件相关"><a href="#目录、文件相关" class="headerlink" title="目录、文件相关"></a>目录、文件相关</h3><h4 id="程序入口"><a href="#程序入口" class="headerlink" title="程序入口"></a>程序入口</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"main"</span>: <span class="string">"lib/index.js"</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>main</code> 属性可以指定程序的主入口文件，例如，上面 <code>antd</code> 指定的模块入口 <code>lib/index.js</code> ，当我们在代码用引入 <code>antd</code> 时：<code>import { notification } from &#39;antd&#39;;</code> 实际上引入的就是 <code>lib/index.js</code> 中暴露出去的模块。</p><p><img src="/Linux/博客搭建/剖析 NPM 的包管理机制/16f0eef2bd8639b2tplv-t2oaga2asx-image.png" alt></p><h4 id="命令行工具入口"><a href="#命令行工具入口" class="headerlink" title="命令行工具入口"></a>命令行工具入口</h4><p>当你的模块是一个命令行工具时，你需要为命令行工具指定一个入口，即指定你的命令名称和本地可指定文件的对应关系。如果是全局安装，npm 将会使用符号链接把可执行文件链接到 <code>/usr/local/bin</code>，如果是本地安装，会链接到 <code>./node_modules/.bin/</code>。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"bin"</span>: &#123;</span><br><span class="line">    <span class="attr">"conard"</span>: <span class="string">"./bin/index.js"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>例如上面的配置：当你的包安装到全局时：<code>npm</code> 会在 <code>/usr/local/bin</code>下创建一个以 <code>conard</code> 为名字的软链接，指向全局安装下来的 <code>conard</code> 包下面的 <code>&quot;./bin/index.js&quot;</code>。这时你在命令行执行 <code>conard</code> 则会调用链接到的这个js文件。</p><blockquote><p>这里不再过多展开，更多内容在我后续的命令行工具文章中会进行详细讲解。</p></blockquote><h4 id="发布文件配置"><a href="#发布文件配置" class="headerlink" title="发布文件配置"></a>发布文件配置</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"files"</span>: [</span><br><span class="line">      <span class="string">"dist"</span>,</span><br><span class="line">      <span class="string">"lib"</span>,</span><br><span class="line">      <span class="string">"es"</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>files</code> 属性用于描述你 <code>npm publish</code> 后推送到 <code>npm</code> 服务器的文件列表，如果指定文件夹，则文件夹内的所有内容都会包含进来。我们可以看到下载后的包是下面的目录结构：</p><p><img src="/Linux/博客搭建/剖析 NPM 的包管理机制/16f0eef2d5915089tplv-t2oaga2asx-image.png" alt></p><blockquote><p>另外，你还可以通过配置一个 <code>.npmignore</code> 文件来排除一些文件, 防止大量的垃圾文件推送到 <code>npm</code>, 规则上和你用的 <code>.gitignore</code> 是一样的。<code>.gitignore</code> 文件也可以充当<code>.npmignore</code> 文件。</p></blockquote><h4 id="man"><a href="#man" class="headerlink" title="man"></a>man</h4><p><code>man</code> 命令是 <code>Linux</code> 下的帮助指令，通过 <code>man</code> 指令可以查看 <code>Linux</code> 中的指令帮助、配置文件帮助和编程帮助等信息。</p><p>如果你的 <code>node.js</code> 模块是一个全局的命令行工具，在 <code>package.json</code> 通过 <code>man</code> 属性可以指定 <code>man</code> 命令查找的文档地址。</p><p><code>man</code> 文件必须以数字结尾，或者如果被压缩了，以 <code>.gz</code> 结尾。数字表示文件将被安装到 <code>man</code> 的哪个部分。如果 <code>man</code> 文件名称不是以模块名称开头的，安装的时候会给加上模块名称前缀。</p><p>例如下面这段配置：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123; </span><br><span class="line">  <span class="attr">"man"</span> : [ </span><br><span class="line">    <span class="string">"/Users/isaacs/dev/npm/cli/man/man1/npm-access.1"</span>,</span><br><span class="line">    <span class="string">"/Users/isaacs/dev/npm/cli/man/man1/npm-audit.1"</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在命令行输入 <code>man npm-audit</code> ：</p><p><img src="/Linux/博客搭建/剖析 NPM 的包管理机制/16f0eef2c221c0cdtplv-t2oaga2asx-image.png" alt></p><h4 id="规范项目目录"><a href="#规范项目目录" class="headerlink" title="规范项目目录"></a>规范项目目录</h4><p>一个 <code>node.js</code> 模块是基于 <code>CommonJS</code> 模块化规范实现的，严格按照 <code>CommonJS</code> 规范，模块目录下除了必须包含包描述文件 <code>package.json</code> 以外，还需要包含以下目录：</p><ul><li><code>bin</code>：存放可执行二进制文件的目录</li><li><code>lib</code>：存放js代码的目录</li><li><code>doc</code>：存放文档的目录</li><li><code>test</code>：存放单元测试用例代码的目录</li><li>…</li></ul><p>在模块目录中你可能没有严格按照以上结构组织或命名，你可以通过在 <code>package.json</code> 指定 <code>directories</code> 属性来指定你的目录结构和上述的规范结构的对应情况。除此之外 <code>directories</code> 属性暂时没有其他应用。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"directories"</span>: &#123;</span><br><span class="line">    <span class="string">"lib"</span>: <span class="string">"src/lib/"</span>,</span><br><span class="line">    <span class="string">"bin"</span>: <span class="string">"src/bin/"</span>,</span><br><span class="line">    <span class="string">"man"</span>: <span class="string">"src/man/"</span>,</span><br><span class="line">    <span class="string">"doc"</span>: <span class="string">"src/doc/"</span>,</span><br><span class="line">    <span class="string">"example"</span>: <span class="string">"src/example/"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>不过官方文档表示，虽然目前这个属性没有什么重要作用，未来可能会整出一些花样出来，例如：doc 中存放的 markdown 文件、example 中存放的示例文件，可能会友好的展示出来。</p></blockquote><h3 id="脚本配置"><a href="#脚本配置" class="headerlink" title="脚本配置"></a>脚本配置</h3><h4 id="script"><a href="#script" class="headerlink" title="script"></a>script</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"test"</span>: <span class="string">"jest --config .jest.js --no-cache"</span>,</span><br><span class="line">    <span class="attr">"dist"</span>: <span class="string">"antd-tools run dist"</span>,</span><br><span class="line">    <span class="attr">"compile"</span>: <span class="string">"antd-tools run compile"</span>,</span><br><span class="line">    <span class="attr">"build"</span>: <span class="string">"npm run compile &amp;&amp; npm run dist"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>scripts</code> 用于配置一些脚本命令的缩写，各个脚本可以互相组合使用，这些脚本可以覆盖整个项目的生命周期，配置后可使用 <code>npm run command</code> 进行调用。如果是 <code>npm</code> 关键字，则可以直接调用。例如，上面的配置制定了以下几个命令：<code>npm run test</code>、<code>npm run dist</code>、<code>npm run compile</code>、<code>npm run build</code>。</p><h4 id="config"><a href="#config" class="headerlink" title="config"></a>config</h4><p><code>config</code> 字段用于配置脚本中使用的环境变量，例如下面的配置，可以在脚本中使用<code>process.env.npm_package_config_port</code>进行获取。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"config"</span> : &#123; <span class="attr">"port"</span> : <span class="string">"8080"</span> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="发布配置"><a href="#发布配置" class="headerlink" title="发布配置"></a>发布配置</h3><h4 id="preferGlobal"><a href="#preferGlobal" class="headerlink" title="preferGlobal"></a>preferGlobal</h4><p>如果你的 <code>node.js</code> 模块主要用于安装到全局的命令行工具，那么该值设置为 <code>true</code> ，当用户将该模块安装到本地时，将得到一个警告。这个配置并不会阻止用户安装，而是会提示用户防止错误使用而引发一些问题。</p><h4 id="private"><a href="#private" class="headerlink" title="private"></a>private</h4><p>如果将 <code>private</code> 属性设置为 <code>true</code>，npm将拒绝发布它，这是为了防止一个私有模块被无意间发布出去。</p><p><img src="/Linux/博客搭建/剖析 NPM 的包管理机制/16f0eef2f07ab9ectplv-t2oaga2asx-image.png" alt></p><h4 id="publishConfig"><a href="#publishConfig" class="headerlink" title="publishConfig"></a>publishConfig</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">"publishConfig": &#123;</span><br><span class="line">  "registry": "https://registry.npmjs.org/"</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>发布模块时更详细的配置，例如你可以配置只发布某个 <code>tag</code>、配置发布到的私有 <code>npm</code> 源。更详细的配置可以参考 <a href="http://caibaojian.com/npm/misc/config.html" target="_blank" rel="noopener">npm-config</a></p><h4 id="os"><a href="#os" class="headerlink" title="os"></a>os</h4><p>假如你开发了一个模块，只能跑在 <code>darwin</code> 系统下，你需要保证 <code>windows</code> 用户不会安装到你的模块，从而避免发生不必要的错误。</p><p>使用 <code>os</code> 属性可以帮助你完成以上的需求，你可以指定你的模块只能被安装在某些系统下，或者指定一个不能安装的系统黑名单：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">"os" : [ "darwin", "linux" ]</span><br><span class="line">"os" : [ "!win32" ]</span><br></pre></td></tr></table></figure><p>例如，我把一个测试模块指定一个系统黑名单：<code>&quot;os&quot; : [ &quot;!darwin&quot; ]</code>，当我在此系统下安装它时会爆出如下错误：</p><p><img src="/Linux/博客搭建/剖析 NPM 的包管理机制/16f0eef2f8072f86tplv-t2oaga2asx-image.png" alt></p><blockquote><p>在node环境下可以使用 process.platform 来判断操作系统。</p></blockquote><h4 id="cpu"><a href="#cpu" class="headerlink" title="cpu"></a>cpu</h4><p>和上面的 <code>os</code> 类似，我们可以用 <code>cpu</code> 属性更精准的限制用户安装环境：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">"cpu" : [ "x64", "ia32" ]</span><br><span class="line">"cpu" : [ "!arm", "!mips" ]</span><br></pre></td></tr></table></figure><blockquote><p>在node环境下可以使用 process.arch 来判断 cpu 架构。</p></blockquote><h2 id="剖析包版本管理机制"><a href="#剖析包版本管理机制" class="headerlink" title="剖析包版本管理机制"></a>剖析包版本管理机制</h2><p><code>Nodejs</code>成功离不开 <code>npm</code> 优秀的依赖管理系统。在介绍整个依赖系统之前，必须要了解 <code>npm</code>如何管理依赖包的版本，本章将介绍 <code>npm包</code> 的版本发布规范、如何管理各种依赖包的版本以及一些关于包版本的最佳实践。</p><p><img src="/Linux/博客搭建/剖析 NPM 的包管理机制/16f0eef301559a8etplv-t2oaga2asx-image.png" alt></p><h3 id="查看npm包版本"><a href="#查看npm包版本" class="headerlink" title="查看npm包版本"></a>查看npm包版本</h3><p>你可以执行 <code>npm view package version</code> 查看某个 <code>package</code> 的最新版本。</p><p>执行 <code>npm view conard versions</code> 查看某个 <code>package</code> 在npm服务器上所有发布过的版本。</p><p><img src="/Linux/博客搭建/剖析 NPM 的包管理机制/16f0eef3016562c8tplv-t2oaga2asx-image.png" alt></p><p>执行 <code>npm ls</code> 可查看当前仓库依赖树上所有包的版本信息。</p><p><img src="/Linux/博客搭建/剖析 NPM 的包管理机制/16f0eef302c760fetplv-t2oaga2asx-image.png" alt></p><h3 id="SemVer规范"><a href="#SemVer规范" class="headerlink" title="SemVer规范"></a>SemVer规范</h3><p><code>npm包</code> 中的模块版本都需要遵循 <code>SemVer</code>规范——由 <code>Github</code> 起草的一个具有指导意义的，统一的版本号表示规则。实际上就是 <code>Semantic Version</code>（语义化版本）的缩写。</p><blockquote><p>SemVer规范官网： <a href="https://semver.org/" target="_blank" rel="noopener">https://semver.org/</a></p></blockquote><h4 id="标准版本"><a href="#标准版本" class="headerlink" title="标准版本"></a>标准版本</h4><p><code>SemVer</code>规范的标准版本号采用 <code>X.Y.Z</code> 的格式，其中 X、Y 和 Z 为非负的整数，且禁止在数字前方补零。X 是主版本号、Y 是次版本号、而 Z 为修订号。每个元素必须以数值来递增。</p><ul><li>主版本号(<code>major</code>)：当你做了不兼容的API 修改</li><li>次版本号(<code>minor</code>)：当你做了向下兼容的功能性新增</li><li>修订号(<code>patch</code>)：当你做了向下兼容的问题修正。</li></ul><p>例如：<code>1.9.1 -&gt; 1.10.0 -&gt; 1.11.0</code></p><h4 id="先行版本"><a href="#先行版本" class="headerlink" title="先行版本"></a>先行版本</h4><p>当某个版本改动比较大、并非稳定而且可能无法满足预期的兼容性需求时，你可能要先发布一个先行版本。</p><p>先行版本号可以加到“主版本号.次版本号.修订号”的后面，先加上一个连接号再加上一连串以句点分隔的标识符和版本编译信息。</p><ul><li>内部版本(<code>alpha</code>):</li><li>公测版本(<code>beta</code>):</li><li>正式版本的候选版本<code>rc</code>: 即 <code>Release candiate</code></li></ul><h4 id="React的版本"><a href="#React的版本" class="headerlink" title="React的版本"></a>React的版本</h4><p>下面我们来看看 <code>React</code> 的历史版本：</p><p><img src="/Linux/博客搭建/剖析 NPM 的包管理机制/16f0eef3224e9335tplv-t2oaga2asx-image.gif" alt></p><p>可见是严格按照 <code>SemVer</code> 规范来发版的：</p><ul><li>版本号严格按照 <code>主版本号.次版本号.修订号</code> 格式命名</li><li>版本是严格递增的，：<code>16.8.0 -&gt; 16.8.1 -&gt; 16.8.2</code></li><li>发布重大版本或版本改动较大时，先发布<code>alpha</code>、<code>beta</code>、<code>rc</code>等先行版本</li></ul><h4 id="发布版本"><a href="#发布版本" class="headerlink" title="发布版本"></a>发布版本</h4><p>在修改 <code>npm</code> 包某些功能后通常需要发布一个新的版本，我们通常的做法是直接去修改 <code>package.json</code> 到指定版本。如果操作失误，很容易造成版本号混乱，我们可以借助符合 <code>Semver</code> 规范的命令来完成这一操作：</p><ul><li><code>npm version patch</code> : 升级修订版本号</li><li><code>npm version minor</code> : 升级次版本号</li><li><code>npm version major</code> : 升级主版本号</li></ul><h3 id="版本工具使用"><a href="#版本工具使用" class="headerlink" title="版本工具使用"></a>版本工具使用</h3><p>在开发中肯定少不了对一些版本号的操作，如果这些版本号符合 <code>SemVer</code>规范 ，我们可以借助用于操作版本的npm包<code>semver</code>来帮助我们进行比较版本大小、提取版本信息等操作。</p><blockquote><p>Npm 也使用了该工具来处理版本相关的工作。</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install semver</span><br></pre></td></tr></table></figure><ul><li><p>比较版本号大小</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">semver.gt(<span class="string">'1.2.3'</span>, <span class="string">'9.8.7'</span>) <span class="comment">// false</span></span><br><span class="line">semver.lt(<span class="string">'1.2.3'</span>, <span class="string">'9.8.7'</span>) <span class="comment">// true</span></span><br></pre></td></tr></table></figure></li><li><p>判断版本号是否符合规范，返回解析后符合规范的版本号。</p></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">semver.valid(<span class="string">'1.2.3'</span>) <span class="comment">// '1.2.3'</span></span><br><span class="line">semver.valid(<span class="string">'a.b.c'</span>) <span class="comment">// null</span></span><br></pre></td></tr></table></figure><ul><li>将其他版本号强制转换成semver版本号</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">semver.valid(semver.coerce(<span class="string">'v2'</span>)) <span class="comment">// '2.0.0'</span></span><br><span class="line">semver.valid(semver.coerce(<span class="string">'42.6.7.9.3-alpha'</span>)) <span class="comment">// '42.6.7'</span></span><br></pre></td></tr></table></figure><ul><li>一些其他用法</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">semver.clean(<span class="string">'  =v1.2.3   '</span>) <span class="comment">// '1.2.3'</span></span><br><span class="line">semver.satisfies(<span class="string">'1.2.3'</span>, <span class="string">'1.x || &gt;=2.5.0 || 5.0.0 - 7.2.3'</span>) <span class="comment">// true</span></span><br><span class="line">semver.minVersion(<span class="string">'&gt;=1.0.0'</span>) <span class="comment">// '1.0.0'</span></span><br></pre></td></tr></table></figure><p>以上都是semver最常见的用法，更多详细内容可以查看 semver文档：<a href="https://github.com/npm/node-semver" target="_blank" rel="noopener">https://github.com/npm/node-semver</a></p><h3 id="依赖版本管理"><a href="#依赖版本管理" class="headerlink" title="依赖版本管理"></a>依赖版本管理</h3><p>我们经常看到，在 <code>package.json</code> 中各种依赖的不同写法：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">"dependencies": &#123;</span><br><span class="line">  "signale": "1.4.0",</span><br><span class="line">  "figlet": "*",</span><br><span class="line">  "react": "16.x",</span><br><span class="line">  "table": "~5.4.6",</span><br><span class="line">  "yargs": "^14.0.0"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>前面三个很容易理解：</p><ul><li><code>&quot;signale&quot;: &quot;1.4.0&quot;</code>: 固定版本号</li><li><code>&quot;figlet&quot;: &quot;*&quot;</code>: 任意版本（<code>&gt;=0.0.0</code>）</li><li><code>&quot;react&quot;: &quot;16.x&quot;</code>: 匹配主要版本（<code>&gt;=16.0.0 &lt;17.0.0</code>）</li><li><code>&quot;react&quot;: &quot;16.3.x&quot;</code>: 匹配主要版本和次要版本（<code>&gt;=16.3.0 &lt;16.4.0</code>）</li></ul><p>再来看看后面两个，版本号中引用了 <code>~</code> 和 <code>^</code> 符号：</p><ul><li><code>~</code>: 当安装依赖时获取到有新版本时，安装到 <code>x.y.z</code> 中 <code>z</code> 的最新的版本。即保持主版本号、次版本号不变的情况下，保持修订号的最新版本。</li><li><code>^</code>: 当安装依赖时获取到有新版本时，安装到 <code>x.y.z</code> 中 <code>y</code> 和 <code>z</code> 都为最新版本。 即保持主版本号不变的情况下，保持次版本号、修订版本号为最新版本。</li></ul><p>在 <code>package.json</code> 文件中最常见的应该是 <code>&quot;yargs&quot;: &quot;^14.0.0&quot;</code> 这种格式的 依赖, 因为我们在使用 <code>npm install package</code> 安装包时，<code>npm</code> 默认安装当前最新版本，然后在所安装的版本号前加 <code>^</code> 号。</p><p>注意，当主版本号为 <code>0</code> 的情况，会被认为是一个不稳定版本，情况与上面不同：</p><ul><li>主版本号和次版本号都为 <code>0</code>: <code>^0.0.z</code>、<code>~0.0.z</code> 都被当作固定版本，安装依赖时均不会发生变化。</li><li>主版本号为 <code>0</code>: <code>^0.y.z</code> 表现和 <code>~0.y.z</code> 相同，只保持修订号为最新版本。</li></ul><blockquote><p>1.0.0 的版本号用于界定公共 API。当你的软件发布到了正式环境，或者有稳定的API时，就可以发布1.0.0版本了。所以，当你决定对外部发布一个正式版本的npm包时，把它的版本标为1.0.0。</p></blockquote><h3 id="锁定依赖版本"><a href="#锁定依赖版本" class="headerlink" title="锁定依赖版本"></a>锁定依赖版本</h3><h4 id="lock文件"><a href="#lock文件" class="headerlink" title="lock文件"></a>lock文件</h4><p>实际开发中，经常会因为各种依赖不一致而产生奇怪的问题，或者在某些场景下，我们不希望依赖被更新，建议在开发中使用 <code>package-lock.json</code>。</p><p>锁定依赖版本意味着在我们不手动执行更新的情况下，每次安装依赖都会安装固定版本。保证整个团队使用版本号一致的依赖。</p><p>每次安装固定版本，无需计算依赖版本范围，大部分场景下能大大加速依赖安装时间。</p><blockquote><p>使用 package-lock.json 要确保npm的版本在5.6以上，因为在5.0 - 5.6中间，对 package-lock.json的处理逻辑进行过几次更新，5.6版本后处理逻辑逐渐稳定。</p></blockquote><p>关于 <code>package-lock.json</code> 详细的结构，我们会在后面的章节进行解析。</p><h4 id="定期更新依赖"><a href="#定期更新依赖" class="headerlink" title="定期更新依赖"></a>定期更新依赖</h4><p>我们的目的是保证团队中使用的依赖一致或者稳定，而不是永远不去更新这些依赖。实际开发场景下，我们虽然不需要每次都去安装新的版本，仍然需要定时去升级依赖版本，来让我们享受依赖包升级带来的问题修复、性能提升、新特性更新。</p><p><img src="/Linux/博客搭建/剖析 NPM 的包管理机制/16f0eef31ae6c1ebtplv-t2oaga2asx-image.png" alt></p><p>使用 <code>npm outdated</code> 可以帮助我们列出有哪些还没有升级到最新版本的依赖：</p><ul><li>黄色表示不符合我们指定的语意化版本范围 - 不需要升级</li><li>红色表示符合指定的语意化版本范围 - 需要升级</li></ul><p>执行 <code>npm update</code> 会升级所有的红色依赖。</p><h3 id="依赖版本选择的最佳实践"><a href="#依赖版本选择的最佳实践" class="headerlink" title="依赖版本选择的最佳实践"></a>依赖版本选择的最佳实践</h3><h4 id="版本发布"><a href="#版本发布" class="headerlink" title="版本发布"></a>版本发布</h4><ul><li>对外部发布一个正式版本的npm包时，把它的版本标为<code>1.0.0</code>。</li><li>某个包版本发行后，任何修改都必须以新版本发行。</li><li>版本号严格按照 <code>主版本号.次版本号.修订号</code> 格式命名</li><li>版本号发布必须是严格递增的</li><li>发布重大版本或版本改动较大时，先发布<code>alpha、beta、rc</code>等先行版本</li></ul><h4 id="依赖范围选择"><a href="#依赖范围选择" class="headerlink" title="依赖范围选择"></a>依赖范围选择</h4><ul><li>主工程依赖了很多子模块，都是团队成员开发的<code>npm</code>包，此时建议把版本前缀改为<code>~</code>，如果锁定的话每次子依赖更新都要对主工程的依赖进行升级，非常繁琐，如果对子依赖完全信任，直接开启<code>^</code>每次升级到最新版本。</li><li>主工程跑在<code>docker</code>线上，本地还在进行子依赖开发和升级，在<code>docker</code>版本发布前要锁定所有依赖版本，确保本地子依赖发布后线上不会出问题。</li></ul><h4 id="保持依赖一致"><a href="#保持依赖一致" class="headerlink" title="保持依赖一致"></a>保持依赖一致</h4><ul><li>确保<code>npm</code>的版本在<code>5.6</code>以上，确保默认开启 <code>package-lock.json</code> 文件。</li><li>由初始化成员执行 <code>npm inatall</code> 后，将 <code>package-lock.json</code> 提交到远程仓库。不要直接提交 <code>node_modules</code>到远程仓库。</li><li>定期执行 <code>npm update</code> 升级依赖，并提交 <code>lock</code> 文件确保其他成员同步更新依赖，不要手动更改 <code>lock</code> 文件。</li></ul><h4 id="依赖变更"><a href="#依赖变更" class="headerlink" title="依赖变更"></a>依赖变更</h4><ul><li>升级依赖: 修改 <code>package.json</code>文件的依赖版本，执行 <code>npm install</code></li><li>降级依赖: 直接执行 <code>npm install package@version</code>(改动<code>package.json</code>不会对依赖进行降级)</li><li>注意改动依赖后提交<code>lock</code>文件</li></ul><h2 id="剖析-npm-install-原理"><a href="#剖析-npm-install-原理" class="headerlink" title="剖析 npm install 原理"></a>剖析 npm install 原理</h2><p><img src="/Linux/博客搭建/剖析 NPM 的包管理机制/16f0eef327ccaba5tplv-t2oaga2asx-image.png" alt></p><p><code>npm install</code> 大概会经过上面的几个流程，这一章就来讲一讲各个流程的实现细节、发展以及为何要这样实现。</p><h3 id="嵌套结构"><a href="#嵌套结构" class="headerlink" title="嵌套结构"></a>嵌套结构</h3><p>我们都知道，执行 <code>npm install</code> 后，依赖包被安装到了 <code>node_modules</code> ，下面我们来具体了解下，<code>npm</code> 将依赖包安装到 <code>node_modules</code> 的具体机制是什么。</p><p>在 <code>npm</code> 的早期版本， <code>npm</code> 处理依赖的方式简单粗暴，以递归的形式，严格按照 <code>package.json</code> 结构以及子依赖包的 <code>package.json</code> 结构将依赖安装到他们各自的 <code>node_modules</code> 中。直到有子依赖包不在依赖其他模块。</p><p>举个例子，我们的模块 <code>my-app</code> 现在依赖了两个模块：<code>buffer</code>、<code>ignore</code>：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"my-app"</span>,</span><br><span class="line">  <span class="attr">"dependencies"</span>: &#123;</span><br><span class="line">    <span class="attr">"buffer"</span>: <span class="string">"^5.4.3"</span>,</span><br><span class="line">    <span class="attr">"ignore"</span>: <span class="string">"^5.1.4"</span>,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ignore</code>是一个纯 <code>JS</code> 模块，不依赖任何其他模块，而 <code>buffer</code> 又依赖了下面两个模块：<code>base64-js</code> 、 <code>ieee754</code>。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"buffer"</span>,</span><br><span class="line">  <span class="attr">"dependencies"</span>: &#123;</span><br><span class="line">    <span class="attr">"base64-js"</span>: <span class="string">"^1.0.2"</span>,</span><br><span class="line">    <span class="attr">"ieee754"</span>: <span class="string">"^1.1.4"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>那么，执行 <code>npm install</code> 后，得到的 <code>node_modules</code> 中模块目录结构就是下面这样的：</p><p><img src="/Linux/博客搭建/剖析 NPM 的包管理机制/16f0eef33997d7f2tplv-t2oaga2asx-image.png" alt></p><p>这样的方式优点很明显， <code>node_modules</code> 的结构和 <code>package.json</code> 结构一一对应，层级结构明显，并且保证了每次安装目录结构都是相同的。</p><p>但是，试想一下，如果你依赖的模块非常之多，你的 <code>node_modules</code> 将非常庞大，嵌套层级非常之深：</p><p><img src="/Linux/博客搭建/剖析 NPM 的包管理机制/16f0eef33d822969tplv-t2oaga2asx-image.png" alt></p><ul><li>在不同层级的依赖中，可能引用了同一个模块，导致大量冗余。</li><li>在 <code>Windows</code> 系统中，文件路径最大长度为260个字符，嵌套层级过深可能导致不可预知的问题。</li></ul><h3 id="扁平结构"><a href="#扁平结构" class="headerlink" title="扁平结构"></a>扁平结构</h3><p>为了解决以上问题，<code>NPM</code> 在 <code>3.x</code> 版本做了一次较大更新。其将早期的嵌套结构改为扁平结构：</p><ul><li>安装模块时，不管其是直接依赖还是子依赖的依赖，优先将其安装在 <code>node_modules</code> 根目录。</li></ul><p>还是上面的依赖结构，我们在执行 <code>npm install</code> 后将得到下面的目录结构：</p><p><img src="/Linux/博客搭建/剖析 NPM 的包管理机制/16f0eef3518941f2tplv-t2oaga2asx-image.png" alt></p><p><img src="/Linux/博客搭建/剖析 NPM 的包管理机制/16f0eef3519475d1tplv-t2oaga2asx-image.png" alt></p><p>此时我们若在模块中又依赖了 <code>base64-js@1.0.1</code> 版本：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"my-app"</span>,</span><br><span class="line">  <span class="attr">"dependencies"</span>: &#123;</span><br><span class="line">    <span class="attr">"buffer"</span>: <span class="string">"^5.4.3"</span>,</span><br><span class="line">    <span class="attr">"ignore"</span>: <span class="string">"^5.1.4"</span>,</span><br><span class="line">    <span class="attr">"base64-js"</span>: <span class="string">"1.0.1"</span>,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>当安装到相同模块时，判断已安装的模块版本是否符合新模块的版本范围，如果符合则跳过，不符合则在当前模块的 <code>node_modules</code> 下安装该模块。</li></ul><p>此时，我们在执行 <code>npm install</code> 后将得到下面的目录结构：</p><p><img src="/Linux/博客搭建/剖析 NPM 的包管理机制/16f0eef355ae3b37tplv-t2oaga2asx-image.png" alt></p><p><img src="/Linux/博客搭建/剖析 NPM 的包管理机制/16f0eef35ae17872tplv-t2oaga2asx-image.png" alt></p><p>对应的，如果我们在项目代码中引用了一个模块，模块查找流程如下：</p><ul><li>在当前模块路径下搜索</li><li>在当前模块 <code>node_modules</code> 路径下搜素</li><li>在上级模块的 <code>node_modules</code> 路径下搜索</li><li>…</li><li>直到搜索到全局路径中的 <code>node_modules</code></li></ul><p>假设我们又依赖了一个包 <code>buffer2@^5.4.3</code>，而它依赖了包 <code>base64-js@1.0.3</code>，则此时的安装结构是下面这样的：</p><p><img src="/Linux/博客搭建/剖析 NPM 的包管理机制/16f0eef377260d67tplv-t2oaga2asx-image.png" alt></p><p>所以 <code>npm 3.x</code> 版本并未完全解决老版本的模块冗余问题，甚至还会带来新的问题。</p><p>试想一下，你的APP假设没有依赖 <code>base64-js@1.0.1</code> 版本，而你同时依赖了依赖不同 <code>base64-js</code> 版本的 <code>buffer</code> 和 <code>buffer2</code>。由于在执行 <code>npm install</code> 的时候，按照 <code>package.json</code> 里依赖的顺序依次解析，则 <code>buffer</code> 和 <code>buffer2</code> 在 <code>package.json</code> 的放置顺序则决定了 <code>node_modules</code> 的依赖结构：</p><p>先依赖<code>buffer2</code>：</p><p><img src="/Linux/博客搭建/剖析 NPM 的包管理机制/16f0eef3824eba10tplv-t2oaga2asx-image.png" alt></p><p>先依赖<code>buffer</code>：</p><p><img src="/Linux/博客搭建/剖析 NPM 的包管理机制/16f0eef38a55f11etplv-t2oaga2asx-image.png" alt></p><p>另外，为了让开发者在安全的前提下使用最新的依赖包，我们在 <code>package.json</code> 通常只会锁定大版本，这意味着在某些依赖包小版本更新后，同样可能造成依赖结构的改动，依赖结构的不确定性可能会给程序带来不可预知的问题。</p><h3 id="Lock文件"><a href="#Lock文件" class="headerlink" title="Lock文件"></a>Lock文件</h3><p>为了解决 <code>npm install</code> 的不确定性问题，在 <code>npm 5.x</code> 版本新增了 <code>package-lock.json</code> 文件，而安装方式还沿用了 <code>npm 3.x</code> 的扁平化的方式。</p><p> <code>package-lock.json</code> 的作用是锁定依赖结构，即只要你目录下有 <code>package-lock.json</code> 文件，那么你每次执行 <code>npm install</code> 后生成的 <code>node_modules</code> 目录结构一定是完全相同的。</p><p>例如，我们有如下的依赖结构：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"my-app"</span>,</span><br><span class="line">  <span class="attr">"dependencies"</span>: &#123;</span><br><span class="line">    <span class="attr">"buffer"</span>: <span class="string">"^5.4.3"</span>,</span><br><span class="line">    <span class="attr">"ignore"</span>: <span class="string">"^5.1.4"</span>,</span><br><span class="line">    <span class="attr">"base64-js"</span>: <span class="string">"1.0.1"</span>,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在执行 <code>npm install</code> 后生成的 <code>package-lock.json</code> 如下：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"my-app"</span>,</span><br><span class="line">  <span class="attr">"version"</span>: <span class="string">"1.0.0"</span>,</span><br><span class="line">  <span class="attr">"dependencies"</span>: &#123;</span><br><span class="line">    <span class="attr">"base64-js"</span>: &#123;</span><br><span class="line">      <span class="attr">"version"</span>: <span class="string">"1.0.1"</span>,</span><br><span class="line">      <span class="attr">"resolved"</span>: <span class="string">"https://registry.npmjs.org/base64-js/-/base64-js-1.0.1.tgz"</span>,</span><br><span class="line">      <span class="attr">"integrity"</span>: <span class="string">"sha1-aSbRsZT7xze47tUTdW3i/Np+pAg="</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"buffer"</span>: &#123;</span><br><span class="line">      <span class="attr">"version"</span>: <span class="string">"5.4.3"</span>,</span><br><span class="line">      <span class="attr">"resolved"</span>: <span class="string">"https://registry.npmjs.org/buffer/-/buffer-5.4.3.tgz"</span>,</span><br><span class="line">      <span class="attr">"integrity"</span>: <span class="string">"sha512-zvj65TkFeIt3i6aj5bIvJDzjjQQGs4o/sNoezg1F1kYap9Nu2jcUdpwzRSJTHMMzG0H7bZkn4rNQpImhuxWX2A=="</span>,</span><br><span class="line">      <span class="attr">"requires"</span>: &#123;</span><br><span class="line">        <span class="attr">"base64-js"</span>: <span class="string">"^1.0.2"</span>,</span><br><span class="line">        <span class="attr">"ieee754"</span>: <span class="string">"^1.1.4"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"dependencies"</span>: &#123;</span><br><span class="line">        <span class="attr">"base64-js"</span>: &#123;</span><br><span class="line">          <span class="attr">"version"</span>: <span class="string">"1.3.1"</span>,</span><br><span class="line">          <span class="attr">"resolved"</span>: <span class="string">"https://registry.npmjs.org/base64-js/-/base64-js-1.3.1.tgz"</span>,</span><br><span class="line">          <span class="attr">"integrity"</span>: <span class="string">"sha512-mLQ4i2QO1ytvGWFWmcngKO//JXAQueZvwEKtjgQFM4jIK0kU+ytMfplL8j+n5mspOfjHwoAg+9yhb7BwAHm36g=="</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"ieee754"</span>: &#123;</span><br><span class="line">      <span class="attr">"version"</span>: <span class="string">"1.1.13"</span>,</span><br><span class="line">      <span class="attr">"resolved"</span>: <span class="string">"https://registry.npmjs.org/ieee754/-/ieee754-1.1.13.tgz"</span>,</span><br><span class="line">      <span class="attr">"integrity"</span>: <span class="string">"sha512-4vf7I2LYV/HaWerSo3XmlMkp5eZ83i+/CDluXi/IGTs/O1sejBNhTtnxzmRZfvOUqj7lZjqHkeTvpgSFDlWZTg=="</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"ignore"</span>: &#123;</span><br><span class="line">      <span class="attr">"version"</span>: <span class="string">"5.1.4"</span>,</span><br><span class="line">      <span class="attr">"resolved"</span>: <span class="string">"https://registry.npmjs.org/ignore/-/ignore-5.1.4.tgz"</span>,</span><br><span class="line">      <span class="attr">"integrity"</span>: <span class="string">"sha512-MzbUSahkTW1u7JpKKjY7LCARd1fU5W2rLdxlM4kdkayuCwZImjkpluF9CM1aLewYJguPDqewLam18Y6AU69A8A=="</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们来具体看看上面的结构：</p><p><img src="/Linux/博客搭建/剖析 NPM 的包管理机制/16f0eef3a81eb51ftplv-t2oaga2asx-image.png" alt></p><p>最外面的两个属性 <code>name</code> 、<code>version</code> 同 <code>package.json</code> 中的 <code>name</code> 和 <code>version</code> ，用于描述当前包名称和版本。</p><p><code>dependencies</code> 是一个对象，对象和 <code>node_modules</code> 中的包结构一一对应，对象的 <code>key</code> 为包名称，值为包的一些描述信息：</p><ul><li><code>version</code>：包版本 —— 这个包当前安装在 <code>node_modules</code> 中的版本</li><li><code>resolved</code>：包具体的安装来源</li><li><code>integrity</code>：包 <code>hash</code> 值，基于 <code>Subresource Integrity</code> 来验证已安装的软件包是否被改动过、是否已失效</li><li><code>requires</code>：对应子依赖的依赖，与子依赖的 <code>package.json</code> 中 <code>dependencies</code>的依赖项相同。</li><li><code>dependencies</code>：结构和外层的 <code>dependencies</code> 结构相同，存储安装在子依赖 <code>node_modules</code> 中的依赖包。</li></ul><p>这里注意，并不是所有的子依赖都有 <code>dependencies</code> 属性，只有子依赖的依赖和当前已安装在根目录的 <code>node_modules</code> 中的依赖冲突之后，才会有这个属性。</p><p>例如，回顾下上面的依赖关系：</p><p><img src="/Linux/博客搭建/剖析 NPM 的包管理机制/16f0eef35ae17872tplv-t2oaga2asx-image.png" alt></p><p>我们在 <code>my-app</code> 中依赖的 <code>base64-js@1.0.1</code> 版本与 <code>buffer</code> 中依赖的 <code>base64-js@^1.0.2</code> 发生冲突，所以 <code>base64-js@1.0.1</code> 需要安装在 <code>buffer</code> 包的 <code>node_modules</code> 中，对应了 <code>package-lock.json</code> 中 <code>buffer</code> 的 <code>dependencies</code> 属性。这也对应了 <code>npm</code> 对依赖的扁平化处理方式。</p><p>所以，根据上面的分析， <code>package-lock.json</code> 文件 和 <code>node_modules</code> 目录结构是一一对应的，即项目目录下存在 <code>package-lock.json</code> 可以让每次安装生成的依赖目录结构保持相同。</p><p>另外，项目中使用了 <code>package-lock.json</code> 可以显著加速依赖安装时间。</p><p>我们使用 <code>npm i --timing=true --loglevel=verbose</code> 命令可以看到 <code>npm install</code> 的完整过程，下面我们来对比下使用 <code>lock</code> 文件和不使用 <code>lock</code> 文件的差别。在对比前先清理下<code>npm</code> 缓存。</p><p>不使用 <code>lock</code> 文件：</p><p><img src="/Linux/博客搭建/剖析 NPM 的包管理机制/16f0eef39713273atplv-t2oaga2asx-image.gif" alt></p><p>使用 <code>lock</code> 文件：</p><p><img src="/Linux/博客搭建/剖析 NPM 的包管理机制/16f0eef3b5e532e0tplv-t2oaga2asx-image.gif" alt></p><p>可见， <code>package-lock.json</code> 中已经缓存了每个包的具体版本和下载链接，不需要再去远程仓库进行查询，然后直接进入文件完整性校验环节，减少了大量网络请求。</p><h4 id="使用建议"><a href="#使用建议" class="headerlink" title="使用建议"></a>使用建议</h4><p>开发系统应用时，建议把 <code>package-lock.json</code> 文件提交到代码版本仓库，从而保证所有团队开发者以及 <code>CI</code> 环节可以在执行 <code>npm install</code> 时安装的依赖版本都是一致的。</p><p>在开发一个 <code>npm</code>包 时，你的 <code>npm</code>包 是需要被其他仓库依赖的，由于上面我们讲到的扁平安装机制，如果你锁定了依赖包版本，你的依赖包就不能和其他依赖包共享同一 <code>semver</code> 范围内的依赖包，这样会造成不必要的冗余。所以我们不应该把<code>package-lock.json</code> 文件发布出去（ <code>npm</code> 默认也不会把 <code>package-lock.json</code> 文件发布出去）。</p><h3 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h3><p>在执行 <code>npm install</code> 或 <code>npm update</code>命令下载依赖后，除了将依赖包安装在<code>node_modules</code> 目录下外，还会在本地的缓存目录缓存一份。</p><p>通过 <code>npm config get cache</code> 命令可以查询到：在 <code>Linux</code> 或 <code>Mac</code> 默认是用户主目录下的 <code>.npm/_cacache</code> 目录。</p><p>在这个目录下又存在两个目录：<code>content-v2</code>、<code>index-v5</code>，<code>content-v2</code> 目录用于存储 <code>tar</code>包的缓存，而<code>index-v5</code>目录用于存储<code>tar</code>包的 <code>hash</code>。</p><p>npm 在执行安装时，可以根据 <code>package-lock.json</code> 中存储的 <code>integrity、version、name</code> 生成一个唯一的 <code>key</code> 对应到 <code>index-v5</code> 目录下的缓存记录，从而找到 <code>tar</code>包的 <code>hash</code>，然后根据 <code>hash</code> 再去找缓存的 <code>tar</code>包直接使用。</p><p>我们可以找一个包在缓存目录下搜索测试一下，在 <code>index-v5</code> 搜索一下包路径：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep <span class="string">"https://registry.npmjs.org/base64-js/-/base64-js-1.0.1.tgz"</span> -r index-v5</span><br></pre></td></tr></table></figure><p><img src="/Linux/博客搭建/剖析 NPM 的包管理机制/16f0eef3b8fb68f5tplv-t2oaga2asx-image.png" alt></p><p>然后我们将json格式化：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"key"</span>: <span class="string">"pacote:version-manifest:https://registry.npmjs.org/base64-js/-/base64-js-1.0.1.tgz:sha1-aSbRsZT7xze47tUTdW3i/Np+pAg="</span>,</span><br><span class="line">  <span class="attr">"integrity"</span>: <span class="string">"sha512-C2EkHXwXvLsbrucJTRS3xFHv7Mf/y9klmKDxPTE8yevCoH5h8Ae69Y+/lP+ahpW91crnzgO78elOk2E6APJfIQ=="</span>,</span><br><span class="line">  <span class="attr">"time"</span>: <span class="number">1575554308857</span>,</span><br><span class="line">  <span class="attr">"size"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"metadata"</span>: &#123;</span><br><span class="line">    <span class="attr">"id"</span>: <span class="string">"base64-js@1.0.1"</span>,</span><br><span class="line">    <span class="attr">"manifest"</span>: &#123;</span><br><span class="line">      <span class="attr">"name"</span>: <span class="string">"base64-js"</span>,</span><br><span class="line">      <span class="attr">"version"</span>: <span class="string">"1.0.1"</span>,</span><br><span class="line">      <span class="attr">"engines"</span>: &#123;</span><br><span class="line">        <span class="attr">"node"</span>: <span class="string">"&gt;= 0.4"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"dependencies"</span>: &#123;&#125;,</span><br><span class="line">      <span class="attr">"optionalDependencies"</span>: &#123;&#125;,</span><br><span class="line">      <span class="attr">"devDependencies"</span>: &#123;</span><br><span class="line">        <span class="attr">"standard"</span>: <span class="string">"^5.2.2"</span>,</span><br><span class="line">        <span class="attr">"tape"</span>: <span class="string">"4.x"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"bundleDependencies"</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">"peerDependencies"</span>: &#123;&#125;,</span><br><span class="line">      <span class="attr">"deprecated"</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">"_resolved"</span>: <span class="string">"https://registry.npmjs.org/base64-js/-/base64-js-1.0.1.tgz"</span>,</span><br><span class="line">      <span class="attr">"_integrity"</span>: <span class="string">"sha1-aSbRsZT7xze47tUTdW3i/Np+pAg="</span>,</span><br><span class="line">      <span class="attr">"_shasum"</span>: <span class="string">"6926d1b194fbc737b8eed513756de2fcda7ea408"</span>,</span><br><span class="line">      <span class="attr">"_shrinkwrap"</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="attr">"bin"</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="attr">"_id"</span>: <span class="string">"base64-js@1.0.1"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"finalized-manifest"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面的 <code>_shasum</code> 属性 <code>6926d1b194fbc737b8eed513756de2fcda7ea408</code> 即为 <code>tar</code> 包的 <code>hash</code>， <code>hash</code>的前几位 <code>6926</code> 即为缓存的前两层目录，我们进去这个目录果然找到的压缩后的依赖包：</p><p><img src="/Linux/博客搭建/剖析 NPM 的包管理机制/16f0eef3bc635b03tplv-t2oaga2asx-image.png" alt></p><blockquote><p>以上的缓存策略是从 npm v5 版本开始的，在 npm v5 版本之前，每个缓存的模块在 ~/.npm 文件夹中以模块名的形式直接存储，储存结构是{cache}/{name}/{version}。</p></blockquote><p><code>npm</code> 提供了几个命令来管理缓存数据：</p><ul><li><code>npm cache add</code>：官方解释说这个命令主要是 <code>npm</code> 内部使用，但是也可以用来手动给一个指定的 package 添加缓存。</li><li><code>npm cache clean</code>：删除缓存目录下的所有数据，为了保证缓存数据的完整性，需要加上 <code>--force</code> 参数。</li><li><code>npm cache verify</code>：验证缓存数据的有效性和完整性，清理垃圾数据。</li></ul><p>基于缓存数据，npm 提供了离线安装模式，分别有以下几种：</p><ul><li><code>--prefer-offline</code>： 优先使用缓存数据，如果没有匹配的缓存数据，则从远程仓库下载。</li><li><code>--prefer-online</code>： 优先使用网络数据，如果网络数据请求失败，再去请求缓存数据，这种模式可以及时获取最新的模块。</li><li><code>--offline</code>： 不请求网络，直接使用缓存数据，一旦缓存数据不存在，则安装失败。</li></ul><h3 id="文件完整性"><a href="#文件完整性" class="headerlink" title="文件完整性"></a>文件完整性</h3><p>上面我们多次提到了文件完整性，那么什么是文件完整性校验呢？</p><p>在下载依赖包之前，我们一般就能拿到 <code>npm</code> 对该依赖包计算的 <code>hash</code> 值，例如我们执行 <code>npm info</code> 命令，紧跟 <code>tarball</code>(下载链接) 的就是 <code>shasum</code>(<code>hash</code>) ：</p><p><img src="/Linux/博客搭建/剖析 NPM 的包管理机制/16f0eef3c2a2dac0tplv-t2oaga2asx-image.png" alt></p><p>用户下载依赖包到本地后，需要确定在下载过程中没有出现错误，所以在下载完成之后需要在本地在计算一次文件的 <code>hash</code> 值，如果两个 <code>hash</code> 值是相同的，则确保下载的依赖是完整的，如果不同，则进行重新下载。</p><h3 id="整体流程"><a href="#整体流程" class="headerlink" title="整体流程"></a>整体流程</h3><p>注意，下面作者在这整体流程的时候，说直接将包解压到 <code>node_modules</code>。其实这样是不严谨的，当遇到需要安装<code>nodejs-addons</code>的时候（对应包下面有<code>binding.gyp</code>文件），并不仅是压缩，还会自动执行<code>node-gyp rebuild</code>编译C/C++代码。关于<code>nodejs-addons</code>的详细介绍可以看下面<code>刨根问底之node-gyp</code>部分的介绍。</p><blockquote><p>该部分的<a href="https://docs.npmjs.com/cli/v9/configuring-npm/package-json" target="_blank" rel="noopener">官方文档</a>说明如下：</p><p>If there is a <code>binding.gyp</code> file in the root of your package and you have not defined an <code>install</code> or <code>preinstall</code> script, npm will default the <code>install</code> command to compile using node-gyp.</p></blockquote><p>好了，我们再来整体总结下上面的流程：</p><ul><li>检查 <code>.npmrc</code> 文件：优先级为：项目级的 <code>.npmrc</code> 文件 &gt; 用户级的 <code>.npmrc</code> 文件&gt; 全局级的 <code>.npmrc</code> 文件 &gt; npm 内置的 <code>.npmrc</code> 文件</li><li><p>检查项目中有无 <code>lock</code> 文件。</p></li><li><p>无 <code>lock</code> 文件：</p><ul><li>从 <code>npm</code> 远程仓库获取包信息</li><li>根据 <code>package.json</code> 构建依赖树，构建过程：<ul><li>构建依赖树时，不管其是直接依赖还是子依赖的依赖，优先将其放置在 <code>node_modules</code> 根目录。</li><li>当遇到相同模块时，判断已放置在依赖树的模块版本是否符合新模块的版本范围，如果符合则跳过，不符合则在当前模块的 <code>node_modules</code> 下放置该模块。</li><li>注意这一步只是确定逻辑上的依赖树，并非真正的安装，后面会根据这个依赖结构去下载或拿到缓存中的依赖包</li></ul></li><li>在缓存中依次查找依赖树中的每个包<ul><li>不存在缓存：<ul><li>从 <code>npm</code> 远程仓库下载包</li><li>校验包的完整性</li><li>校验不通过：<ul><li>重新下载</li></ul></li><li>校验通过：<ul><li>将下载的包复制到 <code>npm</code> 缓存目录</li><li>将下载的包按照依赖结构解压到 <code>node_modules</code></li></ul></li></ul></li><li>存在缓存：将缓存按照依赖结构解压到 <code>node_modules</code></li></ul></li><li>将包解压到 <code>node_modules</code></li><li>生成 <code>lock</code> 文件</li></ul></li><li><p>有 <code>lock</code> 文件：</p><ul><li>检查 <code>package.json</code> 中的依赖版本是否和 <code>package-lock.json</code> 中的依赖有冲突。</li><li>如果没有冲突，直接跳过获取包信息、构建依赖树过程，开始在缓存中查找包信息，后续过程相同</li></ul></li></ul><p><img src="/Linux/博客搭建/剖析 NPM 的包管理机制/16f0eef327ccaba5tplv-t2oaga2asx-image.png" alt></p><p>上面的过程简要描述了 <code>npm install</code> 的大概过程，这个过程还包含了一些其他的操作，例如执行你定义的一些生命周期函数，你可以执行 <code>npm install package --timing=true --loglevel=verbose</code> 来查看某个包具体的安装流程和细节。</p><h3 id="yarn"><a href="#yarn" class="headerlink" title="yarn"></a>yarn</h3><p><img src="/Linux/博客搭建/剖析 NPM 的包管理机制/16f0eef3dde095abtplv-t2oaga2asx-image.png" alt></p><p><code>yarn</code> 是在 <code>2016</code> 年发布的，那时 <code>npm</code> 还处于 <code>V3</code> 时期，那时候还没有 <code>package-lock.json</code> 文件，就像上面我们提到的：不稳定性、安装速度慢等缺点经常会受到广大开发者吐槽。此时，<code>yarn</code> 诞生：</p><p><img src="/Linux/博客搭建/剖析 NPM 的包管理机制/16f0eef3e0ee2fbdtplv-t2oaga2asx-image.png" alt></p><p>上面是官网提到的 <code>yarn</code> 的优点，在那个时候还是非常吸引人的。当然，后来 <code>npm</code> 也意识到了自己的问题，进行了很多次优化，在后面的优化（<code>lock</code>文件、缓存、默认-s…）中，我们多多少少能看到 <code>yarn</code> 的影子，可见 <code>yarn</code> 的设计还是非常优秀的。</p><p> <code>yarn</code> 也是采用的是 <code>npm v3</code> 的扁平结构来管理依赖，安装依赖后默认会生成一个 <code>yarn.lock</code> 文件，还是上面的依赖关系，我们看看 <code>yarn.lock</code> 的结构：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"># THIS IS AN AUTOGENERATED FILE. DO NOT EDIT THIS FILE DIRECTLY.</span><br><span class="line"># yarn lockfile v1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">base64-js@1.0.1:</span><br><span class="line">  version &quot;1.0.1&quot;</span><br><span class="line">  resolved &quot;https://registry.yarnpkg.com/base64-js/-/base64-js-1.0.1.tgz#6926d1b194fbc737b8eed513756de2fcda7ea408&quot;</span><br><span class="line">  integrity sha1-aSbRsZT7xze47tUTdW3i/Np+pAg=</span><br><span class="line"></span><br><span class="line">base64-js@^1.0.2:</span><br><span class="line">  version &quot;1.3.1&quot;</span><br><span class="line">  resolved &quot;https://registry.yarnpkg.com/base64-js/-/base64-js-1.3.1.tgz#58ece8cb75dd07e71ed08c736abc5fac4dbf8df1&quot;</span><br><span class="line">  integrity sha512-mLQ4i2QO1ytvGWFWmcngKO//JXAQueZvwEKtjgQFM4jIK0kU+ytMfplL8j+n5mspOfjHwoAg+9yhb7BwAHm36g==</span><br><span class="line"></span><br><span class="line">buffer@^5.4.3:</span><br><span class="line">  version &quot;5.4.3&quot;</span><br><span class="line">  resolved &quot;https://registry.yarnpkg.com/buffer/-/buffer-5.4.3.tgz#3fbc9c69eb713d323e3fc1a895eee0710c072115&quot;</span><br><span class="line">  integrity sha512-zvj65TkFeIt3i6aj5bIvJDzjjQQGs4o/sNoezg1F1kYap9Nu2jcUdpwzRSJTHMMzG0H7bZkn4rNQpImhuxWX2A==</span><br><span class="line">  dependencies:</span><br><span class="line">    base64-js &quot;^1.0.2&quot;</span><br><span class="line">    ieee754 &quot;^1.1.4&quot;</span><br><span class="line"></span><br><span class="line">ieee754@^1.1.4:</span><br><span class="line">  version &quot;1.1.13&quot;</span><br><span class="line">  resolved &quot;https://registry.yarnpkg.com/ieee754/-/ieee754-1.1.13.tgz#ec168558e95aa181fd87d37f55c32bbcb6708b84&quot;</span><br><span class="line">  integrity sha512-4vf7I2LYV/HaWerSo3XmlMkp5eZ83i+/CDluXi/IGTs/O1sejBNhTtnxzmRZfvOUqj7lZjqHkeTvpgSFDlWZTg==</span><br><span class="line"></span><br><span class="line">ignore@^5.1.4:</span><br><span class="line">  version &quot;5.1.4&quot;</span><br><span class="line">  resolved &quot;https://registry.yarnpkg.com/ignore/-/ignore-5.1.4.tgz#84b7b3dbe64552b6ef0eca99f6743dbec6d97adf&quot;</span><br><span class="line">  integrity sha512-MzbUSahkTW1u7JpKKjY7LCARd1fU5W2rLdxlM4kdkayuCwZImjkpluF9CM1aLewYJguPDqewLam18Y6AU69A8A==</span><br></pre></td></tr></table></figure><p>可见其和 <code>package-lock.json</code> 文件还是比较类似的，还有一些区别就是：</p><ul><li><code>package-lock.json</code> 使用的是 <code>json</code> 格式，<code>yarn.lock</code> 使用的是一种自定义格式</li><li><code>yarn.lock</code> 中子依赖的版本号不是固定的，意味着单独又一个 <code>yarn.lock</code> 确定不了 <code>node_modules</code> 目录结构，还需要和 <code>package.json</code> 文件进行配合。而 <code>package-lock.json</code> 只需要一个文件即可确定。</li></ul><p><code>yarn</code> 的缓策略看起来和 <code>npm v5</code> 之前的很像，每个缓存的模块被存放在独立的文件夹，文件夹名称包含了模块名称、版本号等信息。使用命令 <code>yarn cache dir</code> 可以查看缓存数据的目录：</p><p><img src="/Linux/博客搭建/剖析 NPM 的包管理机制/16f0eef3eb66af39tplv-t2oaga2asx-image.png" alt></p><blockquote><p><code>yarn</code> 默认使用 <code>prefer-online</code> 模式，即优先使用网络数据，如果网络数据请求失败，再去请求缓存数据。</p></blockquote><h2 id="npm常用命令"><a href="#npm常用命令" class="headerlink" title="npm常用命令"></a>npm常用命令</h2><h3 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 创建项目</span><br><span class="line">npm init</span><br><span class="line">// 直接使用默认值创建项目</span><br><span class="line">npm init -y</span><br></pre></td></tr></table></figure><h3 id="镜像源相关"><a href="#镜像源相关" class="headerlink" title="镜像源相关"></a>镜像源相关</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1.查看镜像源</span><br><span class="line">npm get registry</span><br><span class="line">2.切换官方源</span><br><span class="line">npm config <span class="built_in">set</span> registry http://www.npmjs.org</span><br><span class="line">3.切换淘宝源</span><br><span class="line">npm config <span class="built_in">set</span> registry http://registry.npm.taobao.org</span><br></pre></td></tr></table></figure><h3 id="安装模块"><a href="#安装模块" class="headerlink" title="安装模块"></a>安装模块</h3><p>使用<code>npm install 模块名</code>来安装，你可以使用其简写<code>npm i</code>。</p><h4 id="一次性安装多个模块"><a href="#一次性安装多个模块" class="headerlink" title="一次性安装多个模块"></a>一次性安装多个模块</h4><p>无需为你要安装的每个模块都输入一遍 npm i 指令，像这样</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm i gulp-pug</span><br><span class="line">npm i gulp-debug</span><br><span class="line">npm i gulp-sass</span><br></pre></td></tr></table></figure><p>你只需要输入一行命令即可一次性批量安装模块</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i gulp-pug gulp-debug gulp-sass</span><br></pre></td></tr></table></figure><p>如果安装的所有模块的前缀是相同的，则可以这样安装，无需输入完整模块名</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i gulp&#123;-debug,-sass,-pug&#125;</span><br></pre></td></tr></table></figure><h4 id="使用一些安装标志的快捷方式"><a href="#使用一些安装标志的快捷方式" class="headerlink" title="使用一些安装标志的快捷方式"></a>使用一些安装标志的快捷方式</h4><p>如果你想安装一些包到<code>生产环境依赖</code>下面，你通常是这样安装：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm i gulp --save-prod</span><br><span class="line">// 或者</span><br><span class="line">npm i gulp -P</span><br></pre></td></tr></table></figure><p>同理，开发环境下的依赖安装，你可以用 <code>-D</code> 代替 <code>--save-dev</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm i gulp --save-dev</span><br><span class="line">// 或者</span><br><span class="line">npm i gulp -D</span><br></pre></td></tr></table></figure><p>当你<code>不带任何安装标志时</code>，npm <code>默认</code>将模块作为依赖项目添加到<code>package.json</code>文件中。如果你想避免这样，你可以使用 no-save, 这样安装：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i vue --no-save</span><br></pre></td></tr></table></figure><h4 id="npm-install-—save-和-npm-install-—save-dev-的区别"><a href="#npm-install-—save-和-npm-install-—save-dev-的区别" class="headerlink" title="npm install —save 和 npm install —save-dev 的区别"></a>npm install —save 和 npm install —save-dev 的区别</h4><p>以 npm 安装echarts为例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install echarts</span><br></pre></td></tr></table></figure><ul><li>会把 echarts 包安装到 <code>node_modules</code> 目录中</li><li><code>不会修改 package.json</code></li><li>之后运行 <code>npm install</code> 命令时，<code>不会自动安装 echarts</code></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install echarts --save</span><br></pre></td></tr></table></figure><ul><li>会把 echarts 包安装到 node_modules 目录中</li><li>会在 package.json 的 dependencies 属性下添加 echarts</li><li>之后运行 npm install 命令时，会自动安装 echarts 到 node_modules 目录中</li><li>之后运行 npm install -production 或者注明 NODE_ENV 变量值为 production 时，会自动安装 echarts 到 node_modules 目录中</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install echarts --save-dev</span><br></pre></td></tr></table></figure><ul><li>会把 echarts 包安装到 <code>node_modules</code> 目录中</li><li><code>会在 package.json 的 devDependencies 属性下添加 echarts</code></li><li>之后运行 npm install 命令时，会自动安装 echarts 到 node_modules 目录中</li><li>之后运行 <code>npm install -production</code> 或者<code>注明 NODE_ENV 变量值为 production</code> 时，<code>不会自动安装</code>echarts 到 node_modules 目录中</li></ul><h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p><code>devDependencies</code>节点下的模块是我们在<code>开发时</code>需要用的，比如项目中使用的 gulp ，压缩 css、js 的模块。这些模块在我们的项目部署后是不需要的，所以我们可以使用 <code>-save-dev</code> 的形式安装。</p><p>像 echarts 这些模块是项目运行必备的，应该安装在 dependencies 节点下，所以我们应该使用 <code>--save</code> 的形式安装。</p><h3 id="获取安装包信息"><a href="#获取安装包信息" class="headerlink" title="获取安装包信息"></a>获取安装包信息</h3><p>使用 npm view xxx 或 npm v xxx 可以查看包信息，例如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm v vue</span><br></pre></td></tr></table></figure><h3 id="安装指定版本安装包"><a href="#安装指定版本安装包" class="headerlink" title="安装指定版本安装包"></a>安装指定版本安装包</h3><p>如果你想安装一个不是最新版本的安装包，你可以指定某个版本来安装，如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i vue@2.5.15</span><br></pre></td></tr></table></figure><p>鉴于记住标签比记住版本数字容易多了，你可以使用用 npm v 命令来查到的版本信息列表里面的 dist-tag 来安装, 比如</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i vue@beta</span><br></pre></td></tr></table></figure><h3 id="升级依赖包"><a href="#升级依赖包" class="headerlink" title="升级依赖包"></a>升级依赖包</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// 更新全局包：</span><br><span class="line">npm update &lt;name&gt; -g</span><br><span class="line"></span><br><span class="line">// 更新生产环境依赖包：</span><br><span class="line">npm update &lt;name&gt; --save</span><br><span class="line"></span><br><span class="line">// 更新开发环境依赖包：</span><br><span class="line">npm update &lt;name&gt; --save-dev</span><br></pre></td></tr></table></figure><h3 id="卸载包"><a href="#卸载包" class="headerlink" title="卸载包"></a>卸载包</h3><p>如果你不想转到 package.json 文件并手动删除依赖包，则可以用以下方法删除：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm uninstall vue</span><br></pre></td></tr></table></figure><p>这个命令会删除 node_modules 文件夹及 package.json 中对应的包。当然，你也可以用 rm,un 或者 r 来达到相同的效果:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm rm vue</span><br></pre></td></tr></table></figure><p>如果由于某些原因，你只想从 node_modules 文件夹中删除安装包，但是想在 package.json 中保留其依赖项，那么你可以使用 no-save 标志，如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm rm vue --no-save</span><br></pre></td></tr></table></figure><h3 id="依赖枚举"><a href="#依赖枚举" class="headerlink" title="依赖枚举"></a>依赖枚举</h3><p>如果你想看一下你的项目依赖了哪些安装包，你可以这样看：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm ls</span><br></pre></td></tr></table></figure><p>这个命令会将你项目的依赖列举出来，并且各个安装包的依赖也会显示出来。如果你只想看本项目的依赖，你可以这样：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm ls --depth=0</span><br></pre></td></tr></table></figure><p>这样打印出来的结果就是本项目的依赖，像这样：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">├── jquery@3.3.1</span><br><span class="line">├── vue@2.5.17</span><br><span class="line">└── yarn@1.12.3</span><br></pre></td></tr></table></figure><p>当然，你也可以加上 g 来看看你全局安装的依赖包，如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm ls -g -depth 0</span><br></pre></td></tr></table></figure><h3 id="过期依赖枚举"><a href="#过期依赖枚举" class="headerlink" title="过期依赖枚举"></a>过期依赖枚举</h3><p>大多数时候，你需要保持本地依赖的更新，你可以在项目目录下先查看一下安装包有没有版本更新，如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm outdate</span><br></pre></td></tr></table></figure><p>这个命令将会列出所有你可能有更新的过时的安装包列表，如图：</p><p><img src="/Linux/博客搭建/剖析 NPM 的包管理机制/watermark,type_ZmFuZ3poZW5naGVpdGk.png" alt></p><h3 id="执行测试"><a href="#执行测试" class="headerlink" title="执行测试"></a>执行测试</h3><p>你可以使用<code>npm run tests</code>来执行测试用例，但是你可以更方便地用 npm test 或者 npm t 来执行。</p><h3 id="显示可用脚本"><a href="#显示可用脚本" class="headerlink" title="显示可用脚本"></a>显示可用脚本</h3><p>我们可以通过打开 package.json 文件来查看有哪些可执行的脚本，但是我们还可以这样查看：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run</span><br></pre></td></tr></table></figure><p>如果在 package.json 中有如下配置：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"scripts"</span>: &#123;</span><br><span class="line">  <span class="string">"test"</span>: <span class="string">"jest"</span>,</span><br><span class="line">  <span class="string">"build"</span>: <span class="string">"gulp build"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>那么执行这个命令之后，会显示以下信息：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Lifecycle scripts included <span class="keyword">in</span> npm:</span><br><span class="line">  <span class="built_in">test</span></span><br><span class="line">    jest</span><br><span class="line">available via `npm run-script`:</span><br><span class="line">  build</span><br><span class="line">    gulp-build</span><br></pre></td></tr></table></figure><h3 id="列出所有-NPM-环境的可用变量"><a href="#列出所有-NPM-环境的可用变量" class="headerlink" title="列出所有 NPM 环境的可用变量"></a>列出所有 NPM 环境的可用变量</h3><p>你可以使用这个命令来列出所有 NPM 环境的可用变量：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run env | grep npm_</span><br></pre></td></tr></table></figure><p>执行后，将会打印出这样的信息：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">npm_config_fetch_retry_maxtimeout=60000</span><br><span class="line">npm_config_tag_version_prefix=v</span><br><span class="line">npm_config_strict_ssl=<span class="literal">true</span></span><br><span class="line">npm_config_sso_type=oauth</span><br></pre></td></tr></table></figure><p>这样变量的用处就是，可以在脚本中使用它们，还可以创建自己的变量。</p><h3 id="创建自己的-NPM-可用变量"><a href="#创建自己的-NPM-可用变量" class="headerlink" title="创建自己的 NPM 可用变量"></a>创建自己的 NPM 可用变量</h3><p>你可以在 package.json 中添加新的 key 来创建自己的 npm 变量，可以是任何 key ，我更喜欢将所有的 npm 变量都放在一个 config 中，这样看起来比较清晰：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"config"</span>: &#123;</span><br><span class="line">  <span class="string">"build_folder"</span>:<span class="string">"./dist"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>你添加了之后，重新执行<code>npm run env | grep npm_</code>，就能看到以下信息：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">npm_package_config_build_folder=./dist</span><br><span class="line">npm_config_fetch_retry_maxtimeout=60000</span><br><span class="line">npm_config_tag_version_prefix=v</span><br><span class="line">npm_config_strict_ssl=<span class="literal">true</span></span><br><span class="line">npm_config_sso_type=oauth</span><br><span class="line">.</span><br></pre></td></tr></table></figure><p>默认情况下，npm 会重命名你的变量，给其加上<code>前缀npm_package</code>，并将其结构保留在 package.json 文件中，即变为<code>config_build_folder</code>。</p><h3 id="在-npm-脚本中使用-npm-变量"><a href="#在-npm-脚本中使用-npm-变量" class="headerlink" title="在 npm 脚本中使用 npm 变量"></a>在 npm 脚本中使用 npm 变量</h3><p>你可以看到可用变量的完整列表，如果你想使用这些变量中的任何值，就可以在 package.json 中使用了，如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"scripts"</span>: &#123;</span><br><span class="line">  <span class="string">"build"</span>: <span class="string">"gulp build --dist <span class="variable">$npm_package_config_build_folder</span>"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当你执行 npm run build 的时候，实际执行的是这样：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gulp build --dist ./dist</span><br></pre></td></tr></table></figure><h2 id="刨根问底之-node-gyp"><a href="#刨根问底之-node-gyp" class="headerlink" title="刨根问底之 node-gyp"></a>刨根问底之 node-gyp</h2><p>在我们写 node addon 时，需要使用 node-gyp 命令行工具，大部分同学会用<code>configue</code>生成配置文件，然后使用<code>build</code>进行构建。但是 node-gyp 到底是什么？底层有什么呢？下面我们来刨根问底。</p><p>本文的线索是自底向上的讲解 node-gyp 的各层次依赖，主要有以下几个部分：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1. make</span><br><span class="line">2. make install</span><br><span class="line">3. cmake</span><br><span class="line">4. gyp</span><br><span class="line">5. node-gyp</span><br></pre></td></tr></table></figure><p>层次结构如下图所示：</p><p><img src="/Linux/博客搭建/剖析 NPM 的包管理机制/687474703a2f2f7366312d687363646e2d746f.png" alt="img"></p><h3 id="make"><a href="#make" class="headerlink" title="make"></a>make</h3><p>从源文件到可执行文件叫做编译（包括预编译、编译、链接），而 make 作为构建工具掌握着编译的过程，也就是如何去编译、文件编译的顺序等。</p><p>make 是最常用的构建工具，针对用户制定的构建规则（makefile）去执行响应的任务。make 会根据构建规则去查找依赖，决定编译顺序等。大致了解可参考 <a href="http://www.ruanyifeng.com/blog/2015/02/make.html" target="_blank" rel="noopener">Make 命令教程</a></p><p>Makefile（makefile）中定义了 make 的构建规则，当然也可以自己指定规则文件。例如：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ make -f rules.txt</span><br><span class="line"># 或者</span><br><span class="line">$ make --file=rules.txt</span><br></pre></td></tr></table></figure><p>Makefile 由一条条的规则组成，每条规则由 target(目标)、source（前置条件 / 依赖）、command(指令) 三者组成。</p><p>形式如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;target&gt; : &lt;prerequisites&gt; </span><br><span class="line">[tab]  &lt;commands&gt;</span><br></pre></td></tr></table></figure><p>当<code>make target</code>时，主要做了以下几件事：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1.检查目标是否存在</span><br><span class="line">2.如果不存在目标</span><br><span class="line">	· 检查目标的依赖是否存在</span><br><span class="line">	· 不存在则调用`make source`；存在并且没有变化（修改时间戳小于target），不操作</span><br><span class="line">	· 执行target中的command指令</span><br><span class="line">2.如果存在目标</span><br><span class="line">	· 检查依赖是否发生变化</span><br><span class="line">	· 没有变化则不需要执行，有变化则执行`make source`后执行command</span><br></pre></td></tr></table></figure><p>以编译一个 C++ 文件的规则为例：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hellomake: hellomake.c hellofunc.c</span><br><span class="line">     gcc -o hellomake hellomake.c hellofunc.c -I.</span><br></pre></td></tr></table></figure><p>当我们执行 make hellomake，会使用 gcc 编译器编译产出 hellomake。如果 make 不带有参数，则执行 makefile 中的第一条指令。</p><p>make 也允许我们定义一些纯指令（伪指令）去执行一些操作，相当于把上面的 target 写成指令名称，只不过在 command 中不生成文件，所以每次执行该规则时都会执行 command。为了和真实的目标文件做区分，make 中使用了<code>.PHONY</code>关键字，关键字. PHONY 可以解决这问题，告诉 make 该目标是 “假的”（磁盘上其实没有这个目标文件）。例如</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.PHONY: clean</span><br><span class="line">clean:</span><br><span class="line">        rm *.o temp</span><br></pre></td></tr></table></figure><p>由于 makefile 目标只能写一个，所以我们可以使用 all 来将多个目标组合起来。例如：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">all: executable1 executable2</span><br></pre></td></tr></table></figure><p>一般情况下可以把 all 放在 makefile 的第一行，这样不带参数执行 make 就会找到 all。</p><h3 id="make-install"><a href="#make-install" class="headerlink" title="make install"></a>make install</h3><p>make install 用来安装文件，它从 Makefile 中读取指令，安装到系统目录中。</p><h3 id="cmake"><a href="#cmake" class="headerlink" title="cmake"></a>cmake</h3><p>上面提到了 make，似乎已经够了，如果我是一个开发者，我定义了 makefile，让使用者执行 make 编译就好了。但是不同平台的编译器、动态链接库的路径都有可能不同，如果想让你的软件能够跨平台编译、运行，必须要保证能够在不同平台编译。如果使用上面的 Make 工具，就得为每一种标准写一次 Makefile，这是很繁琐并且容易出错的地方。</p><p>cmake 的出现就是为了解决上述问题，它首先允许开发者编写一种平台无关的 CMakeList.txt 文件来定制整个编译流程，cmake 会根据操作系统选择不同编译器，当然也可以在 CMakeList.txt 中去指定，执行 cmake 时会目标用户的平台和自定义的配置生成所需的 Makefile 或工程文件，如 Unix 的 Makefile、Windows 的 Visual Studio。</p><p>CMake 是一个跨平台的安装 (编译) 工具, 可以用简单的语句来描述所有平台的安装(编译过程)。他能够输出各种各样的 makefile 或者 project 文件，能测试编译器所支持的 C++ 特性，类似 UNIX 下的 automake。</p><p>在 linux 平台下使用 CMake 生成 Makefile 并编译的流程如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.编写 CMake 配置文件 CMakeLists.txt 。</span><br><span class="line">2.执行命令 cmake PATH 或者 ccmake PATH 生成 Makefile。其中，PATH是CMakeLists.txt 所在的目录。</span><br><span class="line">3.使用 make 命令进行编译。</span><br></pre></td></tr></table></figure><p>CMakeList.txt 中由面向过程的一条条指令组成，例如：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># CMake 最低版本号要求</span><br><span class="line">cmake_minimum_required (VERSION 2.8)</span><br><span class="line"># 项目信息</span><br><span class="line">project (Demo3)</span><br><span class="line"># 查找当前目录下的所有源文件</span><br><span class="line"># 并将名称保存到 DIR_SRCS 变量</span><br><span class="line">aux_source_directory(. DIR_SRCS)</span><br><span class="line"># 添加 math 子目录</span><br><span class="line">add_subdirectory(math)</span><br><span class="line"># 指定生成目标 </span><br><span class="line">add_executable(Demo main.cc)</span><br><span class="line"># 添加链接库</span><br><span class="line">target_link_libraries(Demo MathFunctions)</span><br></pre></td></tr></table></figure><p>具体可参考 <a href="https://cmake.org/cmake/help/cmake2.4docs.html" target="_blank" rel="noopener">cmake 文档</a></p><h3 id="GYP"><a href="#GYP" class="headerlink" title="GYP"></a>GYP</h3><p>Gyp 是一个类似 CMake 的项目生成工具, 用于管理你的源代码, 在 google code 主页上唯一的一句 slogan 是”GYP can Generate Your Projects.”。GYP 是由 Chromium 团队开发的跨平台自动化项目构建工具，Chromium 便是通过 GYP 进行项目构建管理。</p><p>首先看 GYP 与 cmake 类似，那为什要有 GYP 呢？GYP 和 cmake 有哪些相同点、不同点呢？</p><h4 id="GYP-vs-cmake"><a href="#GYP-vs-cmake" class="headerlink" title="GYP vs cmake"></a>GYP vs cmake</h4><h5 id="相同点："><a href="#相同点：" class="headerlink" title="相同点："></a>相同点：</h5><p>支持跨平台项目工程文件输出，Windows 平台默认是 Visual Studio，Linux 平台默认是 Makefile，Mac 平台默认是 Xcode，这个功能 CMake 也同样支持，只是缺少了 Xcode。</p><h5 id="不同点："><a href="#不同点：" class="headerlink" title="不同点："></a>不同点：</h5><p>配置文件形式不同，GYP 的配置文件更像一个 “配置文件”，而 Cmake 的上述所言更像一个面向过程的一个脚本，也就是说在项目设置的层次上进行抽象；同时 GYP 支持交叉编译。</p><p>具体比较可参考 <a href="http://www.jtianling.com/gyp-developer&#39;s-description-of-gyp.html" target="_blank" rel="noopener">GYP vs. CMake</a></p><h4 id="GYP-配置"><a href="#GYP-配置" class="headerlink" title="GYP 配置"></a>GYP 配置</h4><p>GYP 的配置文件以<code>.gyp</code>结尾，一个典型的<code>.gyp</code>文件如下所示：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &apos;variables&apos;: &#123;</span><br><span class="line">      .</span><br><span class="line">      .</span><br><span class="line">      .</span><br><span class="line">    &#125;,</span><br><span class="line">    &apos;includes&apos;: [</span><br><span class="line">      &apos;../build/common.gypi&apos;,</span><br><span class="line">    ],</span><br><span class="line">    &apos;target_defaults&apos;: &#123;</span><br><span class="line">      .</span><br><span class="line">      .</span><br><span class="line">      .</span><br><span class="line">    &#125;,</span><br><span class="line">    &apos;targets&apos;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &apos;target_name&apos;: &apos;target_1&apos;,</span><br><span class="line">          .</span><br><span class="line">          .</span><br><span class="line">          .</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &apos;target_name&apos;: &apos;target_2&apos;,</span><br><span class="line">          .</span><br><span class="line">          .</span><br><span class="line">          .</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">    &apos;conditions&apos;: [</span><br><span class="line">      [&apos;OS==&quot;linux&quot;&apos;, &#123;</span><br><span class="line">        &apos;targets&apos;: [</span><br><span class="line">          &#123;</span><br><span class="line">            &apos;target_name&apos;: &apos;linux_target_3&apos;,</span><br><span class="line">              .</span><br><span class="line">              .</span><br><span class="line">              .</span><br><span class="line">          &#125;,</span><br><span class="line">        ],</span><br><span class="line">      &#125;],</span><br><span class="line">      [&apos;OS==&quot;win&quot;&apos;, &#123;</span><br><span class="line">        &apos;targets&apos;: [</span><br><span class="line">          &#123;</span><br><span class="line">            &apos;target_name&apos;: &apos;windows_target_4&apos;,</span><br><span class="line">              .</span><br><span class="line">              .</span><br><span class="line">              .</span><br><span class="line">          &#125;,</span><br><span class="line">        ],</span><br><span class="line">      &#125;, &#123; # OS != &quot;win&quot;</span><br><span class="line">        &apos;targets&apos;: [</span><br><span class="line">          &#123;</span><br><span class="line">            &apos;target_name&apos;: &apos;non_windows_target_5&apos;,</span><br><span class="line">              .</span><br><span class="line">              .</span><br><span class="line">              .</span><br><span class="line">          &#125;,</span><br><span class="line">      &#125;],</span><br><span class="line">    ],</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p><code>variables</code> : 定义可以在文件其他地方访问的变量；</p><p><code>includes</code> : 将要被引入到该文件中的文件列表，通常是以<code>.gypi结尾的文件</code>；</p><p><code>target_defaults</code> : 将作用域所有目标的默认配置；</p><p><code>targets</code>: 构建的目标列表，每个 target 中包含构建此目标的所有配置；</p><p><code>conditions</code>: 条件列表，会根据不同条件选择不同的配置项。在最顶级的配置中，通常是平台特定的目标配置。</p><p>具体可参考 <a href="https://gyp.gsrc.io/docs/InputFormatReference.md" target="_blank" rel="noopener">GYP 文档</a></p><h3 id="node-gyp"><a href="#node-gyp" class="headerlink" title="node-gyp"></a>node-gyp</h3><p>node-gyp 是一个跨平台的命令行工具，目的是编译 node addon 模块。</p><p>常用的命令有<code>configure</code>和<code>build</code>，<code>configure</code> 原理就是利用 gyp 生成不同的编译配置文件，<code>build</code>则根据不同平台、不同构建配置进行编译。</p><h4 id="configure"><a href="#configure" class="headerlink" title="configure"></a>configure</h4><p>我们分步骤看下 configure 的代码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">findPython(python, function (err, found) &#123;</span><br><span class="line">    if (err) &#123;</span><br><span class="line">      callback(err)</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      python = found</span><br><span class="line">      getNodeDir()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>由于 GYP 是 python 写的，所以这里首先找当前系统下的 python，内部利用的是<code>which</code>这个第三方库。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">function getNodeDir () &#123;</span><br><span class="line"></span><br><span class="line">    // &apos;python&apos; should be set by now</span><br><span class="line">    process.env.PYTHON = python</span><br><span class="line"></span><br><span class="line">    if (gyp.opts.nodedir) &#123;</span><br><span class="line">      // --nodedir was specified. use that for the dev files</span><br><span class="line">      nodeDir = gyp.opts.nodedir.replace(/^~/, osenv.home())</span><br><span class="line"></span><br><span class="line">      log.verbose(&apos;get node dir&apos;, &apos;compiling against specified --nodedir dev files: %s&apos;, nodeDir)</span><br><span class="line">      createBuildDir()</span><br><span class="line"></span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      gyp.commands.install([ release.version ], function (err, version) &#123;</span><br><span class="line">        if (err) return callback(err)</span><br><span class="line">        log.verbose(&apos;get node dir&apos;, &apos;target node version installed:&apos;, release.versionDir)</span><br><span class="line">        nodeDir = path.resolve(gyp.devDir, release.versionDir)</span><br><span class="line">        createBuildDir()</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>找到 node 所在目录，如果没有，则下载 node 压缩包并解压。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">function createBuildDir () &#123;</span><br><span class="line">    log.verbose(&apos;build dir&apos;, &apos;attempting to create &quot;build&quot; dir: %s&apos;, buildDir)</span><br><span class="line">    mkdirp(buildDir, function (err, isNew) &#123;</span><br><span class="line">      if (err) return callback(err)</span><br><span class="line">      log.verbose(&apos;build dir&apos;, &apos;&quot;build&quot; dir needed to be created?&apos;, isNew)</span><br><span class="line">      if (win &amp;&amp; (!gyp.opts.msvs_version || gyp.opts.msvs_version === &apos;2017&apos;)) &#123;</span><br><span class="line">        findVS2017(function (err, vsSetup) &#123;</span><br><span class="line">          if (err) &#123;</span><br><span class="line">            log.verbose(&apos;Not using VS2017:&apos;, err.message)</span><br><span class="line">            createConfigFile()</span><br><span class="line">          &#125; else &#123;</span><br><span class="line">            createConfigFile(null, vsSetup)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        createConfigFile()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>创建 build 目录，这里区分了是否有 vs，查找 vs 的方法是打开 powershell(windows)，试图打开 vs。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">function createConfigFile (err, vsSetup) &#123;</span><br><span class="line">    if (err) return callback(err)</span><br><span class="line"></span><br><span class="line">    var configFilename = &apos;config.gypi&apos;</span><br><span class="line">    var configPath = path.resolve(buildDir, configFilename)</span><br><span class="line"></span><br><span class="line">    if (vsSetup) &#123;</span><br><span class="line">      // GYP doesn&apos;t (yet) have support for VS2017, so we force it to VS2015</span><br><span class="line">      // to avoid pulling a floating patch that has not landed upstream.</span><br><span class="line">      // Ref: https://chromium-review.googlesource.com/#/c/433540/</span><br><span class="line">      gyp.opts.msvs_version = &apos;2015&apos;</span><br><span class="line">      process.env[&apos;GYP_MSVS_VERSION&apos;] = 2015</span><br><span class="line">      process.env[&apos;GYP_MSVS_OVERRIDE_PATH&apos;] = vsSetup.path</span><br><span class="line">      defaults[&apos;msbuild_toolset&apos;] = &apos;v141&apos;</span><br><span class="line">      defaults[&apos;msvs_windows_target_platform_version&apos;] = vsSetup.sdk</span><br><span class="line">      variables[&apos;msbuild_path&apos;] = path.join(vsSetup.path, &apos;MSBuild&apos;, &apos;15.0&apos;,</span><br><span class="line">                                            &apos;Bin&apos;, &apos;MSBuild.exe&apos;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // loop through the rest of the opts and add the unknown ones as variables.</span><br><span class="line">    // this allows for module-specific configure flags like:</span><br><span class="line">    //</span><br><span class="line">    //   $ node-gyp configure --shared-libxml2</span><br><span class="line">    Object.keys(gyp.opts).forEach(function (opt) &#123;</span><br><span class="line">      if (opt === &apos;argv&apos;) return</span><br><span class="line">      if (opt in gyp.configDefs) return</span><br><span class="line">      variables[opt.replace(/-/g, &apos;_&apos;)] = gyp.opts[opt]</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    configs.push(configPath)</span><br><span class="line">    fs.writeFile(configPath, [prefix, json, &apos;&apos;].join(&apos;\n&apos;), findConfigs)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里创建<code>config.gypi文件</code>，主要包含<code>target_defaults</code>和<code>variables</code>。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line">// config = [&apos;config.gypi&apos;]</span><br><span class="line">  function runGyp (err) &#123;</span><br><span class="line">    if (err) return callback(err)</span><br><span class="line"></span><br><span class="line">    if (!~argv.indexOf(&apos;-f&apos;) &amp;&amp; !~argv.indexOf(&apos;--format&apos;)) &#123;</span><br><span class="line">      if (win) &#123;</span><br><span class="line">        log.verbose(&apos;gyp&apos;, &apos;gyp format was not specified; forcing &quot;msvs&quot;&apos;)</span><br><span class="line">        // force the &apos;make&apos; target for non-Windows</span><br><span class="line">        argv.push(&apos;-f&apos;, &apos;msvs&apos;)</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        log.verbose(&apos;gyp&apos;, &apos;gyp format was not specified; forcing &quot;make&quot;&apos;)</span><br><span class="line">        // force the &apos;make&apos; target for non-Windows</span><br><span class="line">        argv.push(&apos;-f&apos;, &apos;make&apos;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (win &amp;&amp; !hasMsvsVersion()) &#123;</span><br><span class="line">      if (&apos;msvs_version&apos; in gyp.opts) &#123;</span><br><span class="line">        argv.push(&apos;-G&apos;, &apos;msvs_version=&apos; + gyp.opts.msvs_version)</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        argv.push(&apos;-G&apos;, &apos;msvs_version=auto&apos;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // include all the &quot;.gypi&quot; files that were found</span><br><span class="line">    configs.forEach(function (config) &#123;</span><br><span class="line">      argv.push(&apos;-I&apos;, config)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    // For AIX and z/OS we need to set up the path to the exports file</span><br><span class="line">    // which contains the symbols needed for linking. </span><br><span class="line">    var node_exp_file = undefined</span><br><span class="line">    if (process.platform === &apos;aix&apos; || process.platform === &apos;os390&apos;) &#123;</span><br><span class="line">      var ext = process.platform === &apos;aix&apos; ? &apos;exp&apos; : &apos;x&apos;</span><br><span class="line">      var node_root_dir = findNodeDirectory()</span><br><span class="line">      var candidates = undefined </span><br><span class="line">      if (process.platform === &apos;aix&apos;) &#123;</span><br><span class="line">        candidates = [&apos;include/node/node&apos;,</span><br><span class="line">                      &apos;out/Release/node&apos;,</span><br><span class="line">                      &apos;out/Debug/node&apos;,</span><br><span class="line">                      &apos;node&apos;</span><br><span class="line">                     ].map(function(file) &#123;</span><br><span class="line">                       return file + &apos;.&apos; + ext</span><br><span class="line">                     &#125;)</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        candidates = [&apos;out/Release/obj.target/libnode&apos;,</span><br><span class="line">                      &apos;out/Debug/obj.target/libnode&apos;,</span><br><span class="line">                      &apos;lib/libnode&apos;</span><br><span class="line">                     ].map(function(file) &#123;</span><br><span class="line">                       return file + &apos;.&apos; + ext</span><br><span class="line">                     &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">      var logprefix = &apos;find exports file&apos;</span><br><span class="line">      node_exp_file = findAccessibleSync(logprefix, node_root_dir, candidates)</span><br><span class="line">      if (node_exp_file !== undefined) &#123;</span><br><span class="line">        log.verbose(logprefix, &apos;Found exports file: %s&apos;, node_exp_file)</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        var msg = msgFormat(&apos;Could not find node.%s file in %s&apos;, ext, node_root_dir)</span><br><span class="line">        log.error(logprefix, &apos;Could not find exports file&apos;)</span><br><span class="line">        return callback(new Error(msg))</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // this logic ported from the old `gyp_addon` python file</span><br><span class="line">    var gyp_script = path.resolve(__dirname, &apos;..&apos;, &apos;gyp&apos;, &apos;gyp_main.py&apos;)</span><br><span class="line">    var addon_gypi = path.resolve(__dirname, &apos;..&apos;, &apos;addon.gypi&apos;)</span><br><span class="line">    var common_gypi = path.resolve(nodeDir, &apos;include/node/common.gypi&apos;)</span><br><span class="line">    fs.stat(common_gypi, function (err, stat) &#123;</span><br><span class="line">      if (err)</span><br><span class="line">        common_gypi = path.resolve(nodeDir, &apos;common.gypi&apos;)</span><br><span class="line"></span><br><span class="line">      var output_dir = &apos;build&apos;</span><br><span class="line">      if (win) &#123;</span><br><span class="line">        // Windows expects an absolute path</span><br><span class="line">        output_dir = buildDir</span><br><span class="line">      &#125;</span><br><span class="line">      var nodeGypDir = path.resolve(__dirname, &apos;..&apos;)</span><br><span class="line">      var nodeLibFile = path.join(nodeDir,</span><br><span class="line">        !gyp.opts.nodedir ? &apos;&lt;(target_arch)&apos; : &apos;$(Configuration)&apos;,</span><br><span class="line">        release.name + &apos;.lib&apos;)</span><br><span class="line"></span><br><span class="line">      argv.push(&apos;-I&apos;, addon_gypi)</span><br><span class="line">      argv.push(&apos;-I&apos;, common_gypi)</span><br><span class="line">      argv.push(&apos;-Dlibrary=shared_library&apos;)</span><br><span class="line">      argv.push(&apos;-Dvisibility=default&apos;)</span><br><span class="line">      argv.push(&apos;-Dnode_root_dir=&apos; + nodeDir)</span><br><span class="line">      if (process.platform === &apos;aix&apos; || process.platform === &apos;os390&apos;) &#123;</span><br><span class="line">        argv.push(&apos;-Dnode_exp_file=&apos; + node_exp_file)</span><br><span class="line">      &#125;</span><br><span class="line">      argv.push(&apos;-Dnode_gyp_dir=&apos; + nodeGypDir)</span><br><span class="line">      argv.push(&apos;-Dnode_lib_file=&apos; + nodeLibFile)</span><br><span class="line">      argv.push(&apos;-Dmodule_root_dir=&apos; + process.cwd())</span><br><span class="line">      argv.push(&apos;-Dnode_engine=&apos; +</span><br><span class="line">        (gyp.opts.node_engine || process.jsEngine || &apos;v8&apos;))</span><br><span class="line">      argv.push(&apos;--depth=.&apos;)</span><br><span class="line">      argv.push(&apos;--no-parallel&apos;)</span><br><span class="line"></span><br><span class="line">      // tell gyp to write the Makefile/Solution files into output_dir</span><br><span class="line">      argv.push(&apos;--generator-output&apos;, output_dir)</span><br><span class="line"></span><br><span class="line">      // tell make to write its output into the same dir</span><br><span class="line">      argv.push(&apos;-Goutput_dir=.&apos;)</span><br><span class="line"></span><br><span class="line">      // enforce use of the &quot;binding.gyp&quot; file</span><br><span class="line">      argv.unshift(&apos;binding.gyp&apos;)</span><br><span class="line"></span><br><span class="line">      // execute `gyp` from the current target nodedir</span><br><span class="line">      argv.unshift(gyp_script)</span><br><span class="line"></span><br><span class="line">      // make sure python uses files that came with this particular node package</span><br><span class="line">      var pypath = [path.join(__dirname, &apos;..&apos;, &apos;gyp&apos;, &apos;pylib&apos;)]</span><br><span class="line">      if (process.env.PYTHONPATH) &#123;</span><br><span class="line">        pypath.push(process.env.PYTHONPATH)</span><br><span class="line">      &#125;</span><br><span class="line">      process.env.PYTHONPATH = pypath.join(win ? &apos;;&apos; : &apos;:&apos;)</span><br><span class="line"></span><br><span class="line">      var cp = gyp.spawn(python, argv)</span><br><span class="line">      cp.on(&apos;exit&apos;, onCpExit)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里主要是区分了不同平台，给 GYP 命令加入各种参数，其中<code>-I</code>代表 include，最后执行 gyp 脚本生成构建配置文件，比如 unix 下生成 makefile。</p><h4 id="build"><a href="#build" class="headerlink" title="build"></a>build</h4><p><code>build</code>比较简单，言简意赅就是就是区分不同平台，收集不同参数，利用不同编译工具进行编译。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">command = win ? &apos;msbuild&apos; : makeCommand</span><br></pre></td></tr></table></figure><p>区分编译工具。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">function loadConfigGypi () &#123;</span><br><span class="line">    fs.readFile(configPath, &apos;utf8&apos;, function (err, data) &#123;</span><br><span class="line">      if (err) &#123;</span><br><span class="line">        if (err.code == &apos;ENOENT&apos;) &#123;</span><br><span class="line">          callback(new Error(&apos;You must run `node-gyp configure` first!&apos;))</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          callback(err)</span><br><span class="line">        &#125;</span><br><span class="line">        return</span><br><span class="line">      &#125;</span><br><span class="line">      config = JSON.parse(data.replace(/\#.+\n/, &apos;&apos;))</span><br><span class="line"></span><br><span class="line">      // get the &apos;arch&apos;, &apos;buildType&apos;, and &apos;nodeDir&apos; vars from the config</span><br><span class="line">      buildType = config.target_defaults.default_configuration</span><br><span class="line">      arch = config.variables.target_arch</span><br><span class="line">      nodeDir = config.variables.nodedir</span><br><span class="line"></span><br><span class="line">      if (&apos;debug&apos; in gyp.opts) &#123;</span><br><span class="line">        buildType = gyp.opts.debug ? &apos;Debug&apos; : &apos;Release&apos;</span><br><span class="line">      &#125;</span><br><span class="line">      if (!buildType) &#123;</span><br><span class="line">        buildType = &apos;Release&apos;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      log.verbose(&apos;build type&apos;, buildType)</span><br><span class="line">      log.verbose(&apos;architecture&apos;, arch)</span><br><span class="line">      log.verbose(&apos;node dev dir&apos;, nodeDir)</span><br><span class="line"></span><br><span class="line">      if (win) &#123;</span><br><span class="line">        findSolutionFile()</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        doWhich()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>加载<code>config.gypi</code>, 为构建收集一波参数。如果在 windows 下，收集<code>build/*.sln</code>。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">function doBuild () &#123;</span><br><span class="line"></span><br><span class="line">    // Enable Verbose build</span><br><span class="line">    var verbose = log.levels[log.level] &lt;= log.levels.verbose</span><br><span class="line">    if (!win &amp;&amp; verbose) &#123;</span><br><span class="line">      argv.push(&apos;V=1&apos;)</span><br><span class="line">    &#125;</span><br><span class="line">    if (win &amp;&amp; !verbose) &#123;</span><br><span class="line">      argv.push(&apos;/clp:Verbosity=minimal&apos;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (win) &#123;</span><br><span class="line">      // Turn off the Microsoft logo on Windows</span><br><span class="line">      argv.push(&apos;/nologo&apos;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Specify the build type, Release by default</span><br><span class="line">    if (win) &#123;</span><br><span class="line">      var archLower = arch.toLowerCase()</span><br><span class="line">      var p = archLower === &apos;x64&apos; ? &apos;x64&apos; :</span><br><span class="line">              (archLower === &apos;arm&apos; ? &apos;ARM&apos; : &apos;Win32&apos;)</span><br><span class="line">      argv.push(&apos;/p:Configuration=&apos; + buildType + &apos;;Platform=&apos; + p)</span><br><span class="line">      if (jobs) &#123;</span><br><span class="line">        var j = parseInt(jobs, 10)</span><br><span class="line">        if (!isNaN(j) &amp;&amp; j &gt; 0) &#123;</span><br><span class="line">          argv.push(&apos;/m:&apos; + j)</span><br><span class="line">        &#125; else if (jobs.toUpperCase() === &apos;MAX&apos;) &#123;</span><br><span class="line">          argv.push(&apos;/m:&apos; + require(&apos;os&apos;).cpus().length)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      argv.push(&apos;BUILDTYPE=&apos; + buildType)</span><br><span class="line">      // Invoke the Makefile in the &apos;build&apos; dir.</span><br><span class="line">      argv.push(&apos;-C&apos;)</span><br><span class="line">      argv.push(&apos;build&apos;)</span><br><span class="line">      if (jobs) &#123;</span><br><span class="line">        var j = parseInt(jobs, 10)</span><br><span class="line">        if (!isNaN(j) &amp;&amp; j &gt; 0) &#123;</span><br><span class="line">          argv.push(&apos;--jobs&apos;)</span><br><span class="line">          argv.push(j)</span><br><span class="line">        &#125; else if (jobs.toUpperCase() === &apos;MAX&apos;) &#123;</span><br><span class="line">          argv.push(&apos;--jobs&apos;)</span><br><span class="line">          argv.push(require(&apos;os&apos;).cpus().length)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (win) &#123;</span><br><span class="line">      // did the user specify their own .sln file?</span><br><span class="line">      var hasSln = argv.some(function (arg) &#123;</span><br><span class="line">        return path.extname(arg) == &apos;.sln&apos;</span><br><span class="line">      &#125;)</span><br><span class="line">      if (!hasSln) &#123;</span><br><span class="line">        argv.unshift(gyp.opts.solution || guessedSolution)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    var proc = gyp.spawn(command, argv)</span><br><span class="line">    proc.on(&apos;exit&apos;, onExit)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>执行编译命令。</p><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>希望阅读完本篇文章能对你有如下帮助：</p><ul><li>了解 <code>pacakge.json</code> 中的各项详细配置从而对项目工程化配置有更进一步的见解</li><li>掌握 <code>npm</code> 的版本管理机制，能合理配置依赖版本</li><li>理解 <code>npm install</code> 安装原理，能合理运用 <code>npm</code>缓存、<code>package-lock.json</code></li></ul><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://juejin.im/post/6844903552012255245" target="_blank" rel="noopener">https://juejin.im/post/6844903552012255245</a></li><li><a href="https://www.zhihu.com/question/305539244/answer/551386426" target="_blank" rel="noopener">https://www.zhihu.com/question/305539244/answer/551386426</a></li><li><a href="https://zhuanlan.zhihu.com/p/37285173" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/37285173</a></li><li><a href="https://semver.org/lang/zh-CN/" target="_blank" rel="noopener">https://semver.org/lang/zh-CN/</a></li><li><a href="http://deadhorse.me/nodejs/2014/04/27/semver-in-nodejs.html" target="_blank" rel="noopener">http://deadhorse.me/nodejs/2014/04/27/semver-in-nodejs.html</a></li><li><a href="http://caibaojian.com/npm/files/package.json.html" target="_blank" rel="noopener">http://caibaojian.com/npm/files/package.json.html</a></li><li><a href="https://blog.csdn.net/weixin_42752574/article/details/102717415" target="_blank" rel="noopener">npm常用命令(npm install —save 和npm install —save-dev的区别)</a></li><li><a href="https://github.com/tsy77/blog/issues/5" target="_blank" rel="noopener">刨根问底之node-gyp</a></li><li><a href="https://cloud.tencent.com/developer/article/1678828" target="_blank" rel="noopener">发布你的第一个nodejs c++插件</a></li><li><a href="https://blog.conardli.top/2019/12/17/engineering/npm/#3-6-%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B" target="_blank" rel="noopener">剖析 NPM 的包管理机制</a></li><li><a href="https://juejin.cn/post/6844903971220357134#heading-0" target="_blank" rel="noopener">node-gyp 实现 nodejs 调用 C++</a></li></ul></div><div><div style="text-align:center;color:#ccc;font-size:14px">------ 本文结束------</div></div><div class="reward-container"><div>坚持原创技术分享，您的支持将鼓励我继续创作！</div> <button onclick='var qr=document.getElementById("qr");qr.style.display="none"===qr.style.display?"block":"none"'> 打赏</button><div id="qr" style="display:none"><div style="display:inline-block"> <img src="/uploads/wechat.png" alt="zdaiot 微信支付"><p>微信支付</p></div><div style="display:inline-block"> <img src="/uploads/aipay.jpg" alt="zdaiot 支付宝"><p>支付宝</p></div></div></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>本文作者：</strong> zdaiot</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://www.zdaiot.com/Linux/博客搭建/剖析 NPM 的包管理机制/" title="剖析 NPM 的包管理机制">https://www.zdaiot.com/Linux/博客搭建/剖析 NPM 的包管理机制/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="followme"><p>欢迎关注我的其它发布渠道</p><div class="social-list"><div class="social-item"><a target="_blank" class="social-link" href="/uploads/wechat-qcode.jpg"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">WeChat</span></a></div></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/npm/" rel="tag"><i class="fa fa-tag"></i> npm</a><a href="/tags/yarn/" rel="tag"><i class="fa fa-tag"></i> yarn</a><a href="/tags/node-js/" rel="tag"><i class="fa fa-tag"></i> node.js</a></div><div class="post-nav"><div class="post-nav-item"><a href="/Tools/Git/git原理简介/" rel="prev" title="git原理简介"><i class="fa fa-chevron-left"></i> git原理简介</a></div><div class="post-nav-item"></div></div></footer></article></div><div class="comments" id="gitalk-container"></div><script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#剖析-package-json"><span class="nav-number">1.</span> <span class="nav-text">剖析 package.json</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#必备属性"><span class="nav-number">1.1.</span> <span class="nav-text">必备属性</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#npm包命名规则"><span class="nav-number">1.1.1.</span> <span class="nav-text">npm包命名规则</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#查看包是否被占用"><span class="nav-number">1.1.2.</span> <span class="nav-text">查看包是否被占用</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#描述信息"><span class="nav-number">1.2.</span> <span class="nav-text">描述信息</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#基本描述"><span class="nav-number">1.2.1.</span> <span class="nav-text">基本描述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#开发人员"><span class="nav-number">1.2.2.</span> <span class="nav-text">开发人员</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#地址"><span class="nav-number">1.2.3.</span> <span class="nav-text">地址</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#依赖配置"><span class="nav-number">1.3.</span> <span class="nav-text">依赖配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#配置规则"><span class="nav-number">1.3.1.</span> <span class="nav-text">配置规则</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dependencies"><span class="nav-number">1.3.2.</span> <span class="nav-text">dependencies</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#devDependencies"><span class="nav-number">1.3.3.</span> <span class="nav-text">devDependencies</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#peerDependencies"><span class="nav-number">1.3.4.</span> <span class="nav-text">peerDependencies</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#optionalDependencies"><span class="nav-number">1.3.5.</span> <span class="nav-text">optionalDependencies</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#bundledDependencies"><span class="nav-number">1.3.6.</span> <span class="nav-text">bundledDependencies</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#协议"><span class="nav-number">1.4.</span> <span class="nav-text">协议</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#目录、文件相关"><span class="nav-number">1.5.</span> <span class="nav-text">目录、文件相关</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#程序入口"><span class="nav-number">1.5.1.</span> <span class="nav-text">程序入口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#命令行工具入口"><span class="nav-number">1.5.2.</span> <span class="nav-text">命令行工具入口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#发布文件配置"><span class="nav-number">1.5.3.</span> <span class="nav-text">发布文件配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#man"><span class="nav-number">1.5.4.</span> <span class="nav-text">man</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#规范项目目录"><span class="nav-number">1.5.5.</span> <span class="nav-text">规范项目目录</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#脚本配置"><span class="nav-number">1.6.</span> <span class="nav-text">脚本配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#script"><span class="nav-number">1.6.1.</span> <span class="nav-text">script</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#config"><span class="nav-number">1.6.2.</span> <span class="nav-text">config</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#发布配置"><span class="nav-number">1.7.</span> <span class="nav-text">发布配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#preferGlobal"><span class="nav-number">1.7.1.</span> <span class="nav-text">preferGlobal</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#private"><span class="nav-number">1.7.2.</span> <span class="nav-text">private</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#publishConfig"><span class="nav-number">1.7.3.</span> <span class="nav-text">publishConfig</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#os"><span class="nav-number">1.7.4.</span> <span class="nav-text">os</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#cpu"><span class="nav-number">1.7.5.</span> <span class="nav-text">cpu</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#剖析包版本管理机制"><span class="nav-number">2.</span> <span class="nav-text">剖析包版本管理机制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#查看npm包版本"><span class="nav-number">2.1.</span> <span class="nav-text">查看npm包版本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SemVer规范"><span class="nav-number">2.2.</span> <span class="nav-text">SemVer规范</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#标准版本"><span class="nav-number">2.2.1.</span> <span class="nav-text">标准版本</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#先行版本"><span class="nav-number">2.2.2.</span> <span class="nav-text">先行版本</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#React的版本"><span class="nav-number">2.2.3.</span> <span class="nav-text">React的版本</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#发布版本"><span class="nav-number">2.2.4.</span> <span class="nav-text">发布版本</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#版本工具使用"><span class="nav-number">2.3.</span> <span class="nav-text">版本工具使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#依赖版本管理"><span class="nav-number">2.4.</span> <span class="nav-text">依赖版本管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#锁定依赖版本"><span class="nav-number">2.5.</span> <span class="nav-text">锁定依赖版本</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#lock文件"><span class="nav-number">2.5.1.</span> <span class="nav-text">lock文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#定期更新依赖"><span class="nav-number">2.5.2.</span> <span class="nav-text">定期更新依赖</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#依赖版本选择的最佳实践"><span class="nav-number">2.6.</span> <span class="nav-text">依赖版本选择的最佳实践</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#版本发布"><span class="nav-number">2.6.1.</span> <span class="nav-text">版本发布</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#依赖范围选择"><span class="nav-number">2.6.2.</span> <span class="nav-text">依赖范围选择</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#保持依赖一致"><span class="nav-number">2.6.3.</span> <span class="nav-text">保持依赖一致</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#依赖变更"><span class="nav-number">2.6.4.</span> <span class="nav-text">依赖变更</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#剖析-npm-install-原理"><span class="nav-number">3.</span> <span class="nav-text">剖析 npm install 原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#嵌套结构"><span class="nav-number">3.1.</span> <span class="nav-text">嵌套结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#扁平结构"><span class="nav-number">3.2.</span> <span class="nav-text">扁平结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Lock文件"><span class="nav-number">3.3.</span> <span class="nav-text">Lock文件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#使用建议"><span class="nav-number">3.3.1.</span> <span class="nav-text">使用建议</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#缓存"><span class="nav-number">3.4.</span> <span class="nav-text">缓存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#文件完整性"><span class="nav-number">3.5.</span> <span class="nav-text">文件完整性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#整体流程"><span class="nav-number">3.6.</span> <span class="nav-text">整体流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#yarn"><span class="nav-number">3.7.</span> <span class="nav-text">yarn</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#npm常用命令"><span class="nav-number">4.</span> <span class="nav-text">npm常用命令</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建项目"><span class="nav-number">4.1.</span> <span class="nav-text">创建项目</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#镜像源相关"><span class="nav-number">4.2.</span> <span class="nav-text">镜像源相关</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装模块"><span class="nav-number">4.3.</span> <span class="nav-text">安装模块</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#一次性安装多个模块"><span class="nav-number">4.3.1.</span> <span class="nav-text">一次性安装多个模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用一些安装标志的快捷方式"><span class="nav-number">4.3.2.</span> <span class="nav-text">使用一些安装标志的快捷方式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#npm-install-—save-和-npm-install-—save-dev-的区别"><span class="nav-number">4.3.3.</span> <span class="nav-text">npm install —save 和 npm install —save-dev 的区别</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#总结"><span class="nav-number">4.3.4.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#获取安装包信息"><span class="nav-number">4.4.</span> <span class="nav-text">获取安装包信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装指定版本安装包"><span class="nav-number">4.5.</span> <span class="nav-text">安装指定版本安装包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#升级依赖包"><span class="nav-number">4.6.</span> <span class="nav-text">升级依赖包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#卸载包"><span class="nav-number">4.7.</span> <span class="nav-text">卸载包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#依赖枚举"><span class="nav-number">4.8.</span> <span class="nav-text">依赖枚举</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#过期依赖枚举"><span class="nav-number">4.9.</span> <span class="nav-text">过期依赖枚举</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#执行测试"><span class="nav-number">4.10.</span> <span class="nav-text">执行测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#显示可用脚本"><span class="nav-number">4.11.</span> <span class="nav-text">显示可用脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#列出所有-NPM-环境的可用变量"><span class="nav-number">4.12.</span> <span class="nav-text">列出所有 NPM 环境的可用变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建自己的-NPM-可用变量"><span class="nav-number">4.13.</span> <span class="nav-text">创建自己的 NPM 可用变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#在-npm-脚本中使用-npm-变量"><span class="nav-number">4.14.</span> <span class="nav-text">在 npm 脚本中使用 npm 变量</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#刨根问底之-node-gyp"><span class="nav-number">5.</span> <span class="nav-text">刨根问底之 node-gyp</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#make"><span class="nav-number">5.1.</span> <span class="nav-text">make</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#make-install"><span class="nav-number">5.2.</span> <span class="nav-text">make install</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#cmake"><span class="nav-number">5.3.</span> <span class="nav-text">cmake</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GYP"><span class="nav-number">5.4.</span> <span class="nav-text">GYP</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#GYP-vs-cmake"><span class="nav-number">5.4.1.</span> <span class="nav-text">GYP vs cmake</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#相同点："><span class="nav-number">5.4.1.1.</span> <span class="nav-text">相同点：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#不同点："><span class="nav-number">5.4.1.2.</span> <span class="nav-text">不同点：</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#GYP-配置"><span class="nav-number">5.4.2.</span> <span class="nav-text">GYP 配置</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#node-gyp"><span class="nav-number">5.5.</span> <span class="nav-text">node-gyp</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#configure"><span class="nav-number">5.5.1.</span> <span class="nav-text">configure</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#build"><span class="nav-number">5.5.2.</span> <span class="nav-text">build</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#小结"><span class="nav-number">6.</span> <span class="nav-text">小结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考"><span class="nav-number">7.</span> <span class="nav-text">参考</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="zdaiot" src="/uploads/avatar.png"><p class="site-author-name" itemprop="name">zdaiot</p><div class="site-description" itemprop="description">404NotFound</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">318</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">54</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">374</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/zdaiot" title="GitHub → https://github.com/zdaiot" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:zdaiot@163.com" title="E-Mail → mailto:zdaiot@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span><span class="links-of-author-item"><a href="https://www.zhihu.com/people/" title="知乎 → https://www.zhihu.com/people/" rel="noopener" target="_blank"><i class="fa fa-book fa-fw"></i> 知乎</a></span><span class="links-of-author-item"><a href="https://blog.csdn.net/zdaiot" title="CSDN → https://blog.csdn.net/zdaiot" rel="noopener" target="_blank"><i class="fa fa-copyright fa-fw"></i> CSDN</a></span></div><div class="links-of-blogroll motion-element"><div class="links-of-blogroll-title"><i class="link fa-fw"></i> Links</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"> <a href="https://kalacloud.com" title="https://kalacloud.com" rel="noopener" target="_blank">卡拉云低代码工具</a></li></ul></div></div><div class="back-to-top motion-element"><i class="fa fa-arrow-up"></i> <span>0%</span></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="beian"><a href="https://beian.miit.gov.cn" rel="noopener" target="_blank">京ICP备2021031914号</a></div><div class="copyright"> &copy; <span itemprop="copyrightYear">2023</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">zdaiot</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-chart-area"></i></span> <span title="站点总字数">2.4m</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span title="站点阅读时长">36:17</span></div><div class="addthis_inline_share_toolbox"><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5b5e7e498f94b7ad" async="async"></script></div> <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span><script>var now=new Date;function createtime(){var n=new Date("08/01/2018 00:00:00");now.setTime(now.getTime()+250),days=(now-n)/1e3/60/60/24,dnum=Math.floor(days),hours=(now-n)/1e3/60/60-24*dnum,hnum=Math.floor(hours),1==String(hnum).length&&(hnum="0"+hnum),minutes=(now-n)/1e3/60-1440*dnum-60*hnum,mnum=Math.floor(minutes),1==String(mnum).length&&(mnum="0"+mnum),seconds=(now-n)/1e3-86400*dnum-3600*hnum-60*mnum,snum=Math.round(seconds),1==String(snum).length&&(snum="0"+snum),document.getElementById("timeDate").innerHTML="Run for "+dnum+" Days ",document.getElementById("times").innerHTML=hnum+" Hours "+mnum+" m "+snum+" s"}setInterval("createtime()",250)</script><div class="busuanzi-count"><script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv" style="display:none"><span class="post-meta-item-icon"><i class="user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span> <span class="post-meta-divider">|</span><span class="post-meta-item" id="busuanzi_container_site_pv" style="display:none"><span class="post-meta-item-icon"><i class="eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer></div><script src="/lib/anime.min.js"></script><script src="//cdn.jsdelivr.net/gh/theme-next/theme-next-pjax@0/pjax.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script><script data-pjax>!function(){var o,n,e=document.getElementsByTagName("link");if(0<e.length)for(i=0;i<e.length;i++)"canonical"==e[i].rel.toLowerCase()&&e[i].href&&(o=e[i].href);n=o?o.split(":")[0]:window.location.protocol.split(":")[0],o||(o=window.location.href),function(){var e=o,i=document.referrer;if(!/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi.test(e)){var t="https"===String(n).toLowerCase()?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";i?(t+="?r="+encodeURIComponent(document.referrer),e&&(t+="&l="+e)):e&&(t+="?l="+e),(new Image).src=t}}(window)}()</script><script src="/js/local-search.js"></script><div id="pjax"><script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css"><script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : '4800250e682fe873198b',
      clientSecret: '80f7f33f5f8ddfd3944f455cabadda4ff3299147',
      repo        : 'zdaiot.github.io',
      owner       : 'zdaiot',
      admin       : ['zdaiot'],
      id          : 'facadc6e9c99d7d78a37c0b1bfa3770f',
        language: '',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,log:!1,model:{jsonPath:"/live2dw/assets/wanko.model.json"},display:{position:"left",width:150,height:300},mobile:{show:!0}})</script></body></html>